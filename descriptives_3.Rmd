---
title: "The Austrian Corona Panel Project"
author: "Fabian Kalleitner"
date: "06/07/2021"
output:
  html_document:
    df_print: paged
    toc: true
---

```{r setup, include=FALSE}
library("foreign")
#library("codebook")
library("tidyverse")
library("haven")
library("fastDummies")
#library("hrbrthemes")
library("weights")
library("srvyr")
#library("gganimate")
library("ggthemes")
library("panelr")
library("ggpubr")
library("RColorBrewer")
library("readxl")


knitr::opts_chunk$set(
  warning = TRUE, 
  message = TRUE, 
  error = TRUE, 
                
  echo = TRUE  
)
ggplot2::theme_set(ggplot2::theme_bw())
pander::panderOptions("table.split.table", Inf)


```

## TODO

- tables with:
  - variable labels
  - value labels
  - scales
- English translation


# Einleitung
Dieses Dokument zeigt verschiedene Graphentypen der zentralen Variablen des Austrian Corona Panel Projects der W1-24. Ziel ist es möglichst einfach und klar die zeitlichen Veränderungen zu erkennen. Deshalb fokussiert das Dokument auf Variablen, die in mehreren Wellen abgefragt wurden. Dies ist keine Vollständige Auflistung aller Variablen. Siehe für diese das Codebook.

```{r data import and sociodem, include = FALSE}
#setwd("Y:/Wirtschaftssoziologie/Corona/Corona_Panel_Analyse")
bern_data_long2_factored = readRDS("Y:/Wirtschaftssoziologie/Corona/Corona_Panel_Analyse/data/processed/W1-25_CORONAPANEL_recoded.rds")

#variable_doc = read_excel("Y:/Wirtschaftssoziologie/Corona/Daten downloaded/Daten Welle 25/ACPP_Documentation/W1-25_ACPP_Variablelist_V20211002.xlsx",sheet = "Variablenübersicht")

#bern_data_long2_factored <- bern_data_long2_factored %>% mutate_if(is.factor, ~(na_if(.,"Weiss nicht")))
#bern_data_long2_factored <- bern_data_long2_factored %>% mutate_if(is.factor, ~(na_if(.,"keine Angabe")))

bern_data_long2_factored = bern_data_long2_factored
bern_data_long2_factored$wavedate <- as_factor(as.character(bern_data_long2_factored$wave))


#median(as.Date(bern_data_long2_factored$START_DATE[bern_data_long2_factored$wave==24],"%y-%m-%d"),na.rm=TRUE)

levels(bern_data_long2_factored$wavedate) <-c("28.03.2020", "04.04.2020", "11.04.2020","17.04.2020","25.04.2020","03.05.2020","09.05.2020","16.05.2020","24.05.2020","29.05.2020","13.06.2020","27.06.2020","11.07.2020","15.08.2020","12.09.2020","17.10.2020","14.11.2020","13.12.2020","16.01.2021","13.02.2021","13.03.2021","16.04.2021","22.05.2021","26.06.2021","25.09.2021")
bern_data_long2_factored$wavedate = as.Date(bern_data_long2_factored$wavedate, "%d.%m.%Y")

##############################
#RECODING
##############################

bern_data_long2_factored <- bern_data_long2_factored %>% mutate( 
  edu4= ifelse(SD_EDU == "Volksschule oder weniger" | SD_EDU == "Hauptschule oder AHS Unterstufe" | SD_EDU == "Polytechnikum, BMS (Fachschule, z.B. HASCH)", "primary",
         ifelse(SD_EDU == "Lehre, Berufsschule", "Lehre", 
         ifelse(SD_EDU == "AHS mit Matura" | SD_EDU == "BHS mit Matura (z.B. HTL, HAK, HBLA etc.)" | SD_EDU == "Hochschulverwandte Lehranstalt oder Kolleg", "secondary",
        ifelse(SD_EDU == "Bachelor" | SD_EDU == "Magister / Master / Diplomingenieur / Fachhochschule" | SD_EDU == "Doktor / PhD", "tertiary",NA)))))

bern_data_long2_factored$edu4 <- as.factor(bern_data_long2_factored$edu4)

bern_data_long2_factored$edu4 <- fct_relevel(bern_data_long2_factored$edu4, "primary","Lehre","secondary","tertiary" )

bern_data_long2_factored <- bern_data_long2_factored %>% mutate(alter=2020-SD_BIRTHYEAR)

bern_data_long2_factored <- bern_data_long2_factored %>% mutate(alter_g=ifelse(alter<30,"<30",
                                                                               ifelse(alter>=30&alter<60,"30-59",
                                                                               ifelse(alter>=60,">60",NA))))

bern_data_long2_factored$alter_g <- as.factor(bern_data_long2_factored$alter_g)

bern_data_long2_factored$alter_g <- fct_relevel(bern_data_long2_factored$alter_g, "<30", "30-59", ">60")

bern_data_long2_factored <-  bern_data_long2_factored %>% mutate(gender=ifelse(SD_GENDER=="Maennlich","male",
                                                                        ifelse(SD_GENDER=="Weiblich","female",NA)))

bern_data_long2_factored$gender <- as.factor(bern_data_long2_factored$gender)

bern_data_long2_factored$bula = as.factor(droplevels(bern_data_long2_factored$SD_BULA))
bern_data_long2_factored$bula = bern_data_long2_factored$bula %>% fct_relevel(., sort)
levels(bern_data_long2_factored$bula)<-c("BG","KT","NÖ","OÖ","SB","ST","TI","VB","WI")

bern_data_long2_factored <- bern_data_long2_factored %>% mutate( 
  hh_inc_cur_quintile= ifelse(hh_inc_cur=="weniger als 1.100 Euro" | hh_inc_cur=="1.100 bis unter 1.500 Euro", "1.Quintile",
                   ifelse(hh_inc_cur=="1.500 bis unter 1.800 Euro" | hh_inc_cur=="1.800 bis unter 2.200 Euro", "2.Quintile", 
                   ifelse(hh_inc_cur=="2.200 bis unter 2.700 Euro" | hh_inc_cur=="2.700 bis unter 3.100 Euro", "3.Quintile" ,
                   ifelse(hh_inc_cur=="3.100 bis unter 3.700 Euro" | hh_inc_cur=="3.700 bis unter 4.300 Euro", "4.Quintile", 
                   ifelse(hh_inc_cur=="4.300 bis unter 5.500 Euro" | hh_inc_cur=="5.500 Euro und mehr"       , "5.Quintile",NA))))))


bern_data_long2_factored <- bern_data_long2_factored %>% mutate( 
  hh_inc_cur_3g  = ifelse(hh_inc_cur=="weniger als 1.100 Euro"     | hh_inc_cur=="1.100 bis unter 1.500 Euro" | hh_inc_cur=="1.500 bis unter 1.800 Euro" , "1-3.Decile",
                   ifelse(hh_inc_cur=="1.800 bis unter 2.200 Euro" | hh_inc_cur=="2.200 bis unter 2.700 Euro" | hh_inc_cur=="2.700 bis unter 3.100 Euro" 
                        | hh_inc_cur=="3.100 bis unter 3.700 Euro", "4-7.Decile",
                   ifelse(hh_inc_cur=="3.700 bis unter 4.300 Euro" | hh_inc_cur=="4.300 bis unter 5.500 Euro" | hh_inc_cur=="5.500 Euro und mehr"       , "8-10.Decile",NA))))


bern_data_long2_factored <- bern_data_long2_factored %>% mutate( 
  population_3g  = ifelse(SD_POPNUM=="<2.500"  | SD_POPNUM=="2.500-" | SD_POPNUM=="5.000-" , "<10.000",
                   ifelse(SD_POPNUM=="10.000-" | SD_POPNUM=="50.000-", "10.000–1 Million",
                   ifelse(SD_POPNUM=="1M.+", ">1 Million",NA))))

bern_data_long2_factored$population_3g <- as.factor(bern_data_long2_factored$population_3g)
bern_data_long2_factored$population_3g <- fct_relevel(bern_data_long2_factored$population_3g, "<10.000","10.000–1 Million",">1 Million")


```


```{r recoding and export, echo=FALSE, fig.width=8, fig.height=5, results='asis'}
lr_gen_w1 <- bern_data_long2_factored %>% filter(!is.na(WEIGHTD))

#List of all variables in the data
#names(lr_gen_w1)
#paste(names(lr_gen_w1),collapse=",")



#What variables should be used for the dashboard
 variablelist <- c("ges_per_gefahr","ges_pub_gefahr","wir_per_gefahr","wir_pub_gefahr",
                   "wochentag","kontakt","zeit" ,"konflikt","kinder",
                   "depress_A1","depress_A2","depress_A3","depress_A4","depress_A5","depress_A6","depress_A7","depress_A8","depress_A9",
                   "zusammenhalt","umweundklima","onlinekommun",
                   "demokratie","lebensz",
                   "zus_bestes","zus_einig","zus_schutzen",
                   "blianz_reg",
                   "zuf_reg_al","zuf_reg_un","zuf_reg_wi",
                   "mas_angemessen","mas_effektiv",
                   "ver_gov","ver_ges","ver_par","ver_pol","ver_orf",
                   "dauer",
                   "fin_ausk_akt")
                                     #"sozialn_mein_and_abs","sozialn_mein_and_bes","sozialn_mein_and_ges","sozialn_mein_and_hau","sozialn_mein_and_sch","sozialn_mein_and_ver",
 #                   "sozialn_verh_and_abs", "sozialn_verh_and_hau","sozialn_verh_and_sch","sozialn_verh_and_ver",
 #                   "sozialn_verh_eig_abs", "sozialn_verh_eig_hau","sozialn_verh_eig_sch","sozialn_verh_eig_ver",
 #                   "zuf_fam","zuf_par","zuf_ber","zuf_frz",
 #                   "berufst"

#variablelist <- c("ges_per_gefahr","ges_pub_gefahr","wochentag","kontakt","lebensz")

#What are the crucial values to identify individual datapoints and what are the categories for subgroup analyses
sociodem <-c("WEIGHTD","wave","wavedate","gender","alter_g","edu4","population_3g","hh_inc_cur_3g")

#Get the different factor scales in the data and generate a dataframe indicating which variables use different answer scales
labels <- lr_gen_w1 %>% ungroup() %>% select(variablelist) %>%  sapply(levels)

df <- do.call(rbind, labels) %>% as.data.frame()
df <-bind_rows(lapply(labels,function(y) as.data.frame(t(y),stringsAsFactors=FALSE,y.id = "column_label")))
rownames(df)<-names(labels)
#grouped_labels<- df %>% mutate(ID = group_indices(.,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10,V11,V12)) 
grouped_labels<- df %>% 
  mutate(variable=rownames(.)) %>%
  group_by(V1,V2,V3,V4,V5,V6,V7,V8,V9,V10,V11,V12,V13) %>% #,V13
  mutate(ID = group_indices()) #%>% 


#hinzufügen von nummerierung in labels ohne nummerierung
df2<-df

df2<-df2%>%mutate(V1 = ifelse(!is.na(df$V1) & df$V1!="Weiss nicht" & df$V1!="keine Angabe" & grepl("^[^0-9]",df$V1),
                              paste0("0 = ", df$V1),
                               ifelse(!is.na(df$V1),V1,NA)))
df2<-df2%>%mutate(V2 = ifelse(!is.na(df$V2) & df$V2!="Weiss nicht" & df$V2!="keine Angabe" & grepl("^[^0-9]",df$V2),
                              paste0("1 = ", df$V2),
                               ifelse(!is.na(df$V2),V2,NA)))
df2<-df2%>%mutate(V3 = ifelse(!is.na(df$V3) & df$V3!="Weiss nicht" & df$V3!="keine Angabe" & grepl("^[^0-9]",df$V3),
                              paste0("2 = ", df$V3),
                               ifelse(!is.na(df$V3),V3,NA)))
df2<-df2%>%mutate(V4 = ifelse(!is.na(df$V4) & df$V4!="Weiss nicht" & df$V4!="keine Angabe" & grepl("^[^0-9]",df$V4),
                              paste0("3 = ", df$V4),
                               ifelse(!is.na(df$V4),V4,NA)))
df2<-df2%>%mutate(V5 = ifelse(!is.na(df$V5) & df$V5!="Weiss nicht" & df$V5!="keine Angabe" & grepl("^[^0-9]",df$V5),
                              paste0("4 = ", df$V5),
                               ifelse(!is.na(df$V5),V5,NA)))
df2<-df2%>%mutate(V6 = ifelse(!is.na(df$V6) & df$V6!="Weiss nicht" & df$V6!="keine Angabe" & grepl("^[^0-9]",df$V6),
                              paste0("5 = ", df$V6),
                               ifelse(!is.na(df$V6),V6,NA)))
df2<-df2%>%mutate(V7 = ifelse(!is.na(df$V7) & df$V7!="Weiss nicht" & df$V7!="keine Angabe" & grepl("^[^0-9]",df$V7),
                              paste0("6 = ", df$V7),
                               ifelse(!is.na(df$V7),V7,NA)))
df2<-df2%>%mutate(V8 = ifelse(!is.na(df$V8) & df$V8!="Weiss nicht" & df$V8!="keine Angabe" & grepl("^[^0-9]",df$V8),
                              paste0("7 = ", df$V8),
                               ifelse(!is.na(df$V8),V8,NA)))
df2<-df2%>%mutate(V9 = ifelse(!is.na(df$V9) & df$V9!="Weiss nicht" & df$V9!="keine Angabe" & grepl("^[^0-9]",df$V9),
                              paste0("8 = ", df$V9),
                               ifelse(!is.na(df$V9),V9,NA)))
df2<-df2%>%mutate(V10 = ifelse(!is.na(df$V10) & df$V10!="Weiss nicht" & df$V10!="keine Angabe" & grepl("^[^0-9]",df$V10),
                               paste0("9 = ", df$V10),
                               ifelse(!is.na(df$V10),V10,NA)))
df2<-df2%>%mutate(V11 = ifelse(!is.na(df$V11) & df$V11!="Weiss nicht" & df$V11!="keine Angabe" & grepl("^[^0-9]",df$V11),
                               paste0("10 = ", df$V11),
                               ifelse(!is.na(df$V11),V11,NA)))
df2<-df2%>%mutate(V12 = ifelse(!is.na(df$V12) & df$V12!="Weiss nicht" & df$V12!="keine Angabe" & grepl("^[^0-9]",df$V12),
                               paste0("11 = ", df$V12),
                               ifelse(!is.na(df$V12),V12,NA)))
df2<-df2%>%mutate(V13 = ifelse(!is.na(df$V13) & df$V13!="Weiss nicht" & df$V13!="keine Angabe" & grepl("^[^0-9]",df$V13),
                               paste0("12 = ", df$V13),
                               ifelse(!is.na(df$V13),V13,NA)))

df2<-df2 %>% mutate(variable=rownames(.))

df2$V5[df2$V5=="4 = Mehr als 6 Monate"]<-"7 = Mehr als 6 Monate"


for (val in df2$variable) {
  #print(val)
  test<-df2%>%filter(variable==val)%>%select(starts_with("V", ignore.case=FALSE))
  levels(lr_gen_w1[[val]])<-as.vector(t(test[colSums(!is.na(test)) > 0]))
}

 

grouped_labels<-grouped_labels%>% group_by(ID) %>% summarise(variable)

#import reverse information (which variable scales to reverse)
rev_labels<-readr::read_csv("./output/tables/varlabels_rev_2.csv",show_col_types = FALSE)
grouped_labels<- grouped_labels %>% left_join(rev_labels, by = "variable")

#select the data for analyses
lr_gen_w2 <- lr_gen_w1 %>% select(c(variablelist,sociodem))

#group the data into different dataframes within a list according to their answer scales
count=0
out <- vector('list', max(unique(grouped_labels$ID)))
for (val in unique(grouped_labels$ID)) {
count = count+1
out[[count]] <- gather(lr_gen_w2, variable, measurement, grouped_labels%>%filter(ID==count)%>%ungroup()%>%pull(variable), factor_key=TRUE) %>%
  select(id,wave,WEIGHTD,wavedate,gender,alter_g,edu4,population_3g,hh_inc_cur_3g,variable,measurement)
out[[count]]$measurement<-as.factor(out[[count]]$measurement)
out[[count]]$measurement=fct_relevel(out[[count]]$measurement,levels(lr_gen_w2[[(grouped_labels%>%filter(ID==count)%>%ungroup()%>%pull(variable))[1]]]))

#out[[count]] <- pivot_longer(lr_gen_w2,grouped_labels%>%filter(ID==count)%>%ungroup()%>%pull(variable), names_to = "variable", values_to = "measurement") 
#out[[count]] <- gather(lr_gen_w2, variable, measurement, grouped_labels%>%filter(ID==count)%>%ungroup()%>%pull(variable), factor_key=FALSE) #%>%
  #select(id,wave,WEIGHTD,wavedate,gender,alter_g,edu4,population_3g,hh_inc_cur_3g,variable,measurement)
print(count)
}

#calculate N and shares of variables by wave and variable within each specific scale specific dataframe 
data_plot_long_N<- vector('list', max(unique(grouped_labels$ID)))
data_plot_long<- vector('list', max(unique(grouped_labels$ID)))
for (val in unique(grouped_labels$ID)) {
data_plot_long_N[[val]]<-out[[val]] %>% filter(!is.na(measurement)) %>% 
 group_by(wavedate,variable) %>% tally() %>% rename(N_total=n)

data_plot_long[[val]]<-out[[val]] %>% filter(!is.na(measurement)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable,measurement) %>% 
  summarise(n=survey_total(vartype = c("se")))

data_plot_long[[val]]<-data_plot_long[[val]] %>% group_by(wavedate,variable) %>%
     mutate(prop = n/sum(n),ymax=prop+1.96*sqrt(n/sum(n))*(1-(n/sum(n)))/n, ymin=prop-1.96*sqrt(n/sum(n))*(1-(n/sum(n)))/n,groupby="none")
print(val)
}

#append it and add new variable with levels of measurement as content indicating different scales
data_plot_long_new<-bind_rows(data_plot_long, .id = 'scales')
data_plot_long_N_new<-bind_rows(data_plot_long_N, .id = 'scales')

#Remove "Number = " in labels of measurement
#data_plot_long_new<-data_plot_long_new %>% mutate(measurement=gsub("^.*?= ","",measurement))

#MEAN VALUES#################################################################
#out

#mean line attention recoding 5= sehr groß 1= sehr klein

data_plot_long_mean<- vector('list', max(unique(grouped_labels$ID)))
data_plot_long_mean_ge<- vector('list', max(unique(grouped_labels$ID)))
data_plot_long_mean_ag<- vector('list', max(unique(grouped_labels$ID)))
data_plot_long_mean_ed<- vector('list', max(unique(grouped_labels$ID)))
data_plot_long_mean_bl<- vector('list', max(unique(grouped_labels$ID)))
data_plot_long_mean_hi<- vector('list', max(unique(grouped_labels$ID)))

grouped_labels_sum <- grouped_labels %>% group_by(ID) %>% filter(row_number()==1)

#test

# data_plot_long_mean[[3]] <- out[[3]]  %>% filter(!is.na(measurement)) %>%
#   as_survey_design(weights = c(WEIGHTD)) %>%
#   group_by(wavedate,variable) %>%
#   summarise(mean_measurement=survey_mean(abs((as.numeric(measurement)-grouped_labels_sum$min[grouped_labels_sum$ID==3])+((grouped_labels_sum$max[grouped_labels_sum$ID==3]-grouped_labels_sum$min[grouped_labels_sum$ID==3])*(-grouped_labels_sum$rev[grouped_labels_sum$ID==3]))),vartype = c("se"))) %>%
#   group_by(wavedate,variable) %>%
#      mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="all",subgroup="none")

#endtest

for (val in unique(grouped_labels$ID)) {
#mean general
  print("start")
  print(val)
data_plot_long_mean[[val]] <- out[[val]]  %>% filter(!is.na(measurement)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable) %>%
  summarise(mean_measurement=survey_mean(abs((as.numeric(as.factor(measurement))-grouped_labels_sum$min[val])+((grouped_labels_sum$max[val]-grouped_labels$min[val])*(-grouped_labels_sum$rev[val]))),vartype = c("se"))) %>% 
  group_by(wavedate,variable) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="all",subgroup="none")


#mean by Gender
data_plot_long_mean_ge[[val]] <- out[[val]]  %>% filter(!is.na(measurement)&!is.na(gender)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable,gender) %>%
 summarise(mean_measurement=survey_mean(abs((as.numeric(as.factor(measurement))-grouped_labels_sum$min[val])+((grouped_labels_sum$max[val]-grouped_labels_sum$min[val])*(-grouped_labels_sum$rev[val]))),vartype = c("se"))) %>%  
  group_by(wavedate,variable,gender) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="ge")

#mean by Age
data_plot_long_mean_ag[[val]] <- out[[val]]  %>% filter(!is.na(measurement)&!is.na(alter_g)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable,alter_g) %>%
  summarise(mean_measurement=survey_mean(abs((as.numeric(as.factor(measurement))-grouped_labels_sum$min[val])+((grouped_labels_sum$max[val]-grouped_labels_sum$min[val])*(-grouped_labels_sum$rev[val]))),vartype = c("se"))) %>%  
  group_by(wavedate,variable,alter_g) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="ag")

#mean by Education
data_plot_long_mean_ed[[val]] <- out[[val]]  %>% filter(!is.na(measurement)&!is.na(edu4)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable,edu4) %>%
  summarise(mean_measurement=survey_mean(abs((as.numeric(as.factor(measurement))-grouped_labels_sum$min[val])+((grouped_labels_sum$max[val]-grouped_labels_sum$min[val])*(-grouped_labels_sum$rev[val]))),vartype = c("se"))) %>%  
  group_by(wavedate,variable,edu4) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="ed")

#mean by size of home municipality
data_plot_long_mean_bl[[val]] <- out[[val]]  %>% filter(!is.na(measurement)&!is.na(population_3g)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable,population_3g) %>%
  summarise(mean_measurement=survey_mean(abs((as.numeric(as.factor(measurement))-grouped_labels_sum$min[val])+((grouped_labels_sum$max[val]-grouped_labels_sum$min[val])*(-grouped_labels_sum$rev[val]))),vartype = c("se"))) %>%  
  group_by(wavedate,variable,population_3g) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="bl")

#mean by Household Income
data_plot_long_mean_hi[[val]] <- out[[val]]  %>% filter(!is.na(measurement)&!is.na(hh_inc_cur_3g)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,variable,hh_inc_cur_3g) %>%
  summarise(mean_measurement=survey_mean(abs((as.numeric(as.factor(measurement))-grouped_labels_sum$min[val])+((grouped_labels_sum$max[val]-grouped_labels_sum$min[val])*(-grouped_labels_sum$rev[val]))),vartype = c("se"))) %>%  
  group_by(wavedate,variable,hh_inc_cur_3g) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se,groupby="hi")
print(val)
print("end")
}

#append it and add new variable with levels of measurement as content indicating different scales
data_plot_long_mean_new<-bind_rows(data_plot_long_mean, .id = 'scales')
data_plot_long_mean_ge_new<-bind_rows(data_plot_long_mean_ge, .id = 'scales')%>%rename("subgroup" = gender)
data_plot_long_mean_ag_new<-bind_rows(data_plot_long_mean_ag, .id = 'scales')%>%rename("subgroup" = alter_g)
data_plot_long_mean_ed_new<-bind_rows(data_plot_long_mean_ed, .id = 'scales')%>%rename("subgroup" = edu4)
data_plot_long_mean_bl_new<-bind_rows(data_plot_long_mean_bl, .id = 'scales')%>%rename("subgroup" = population_3g)
data_plot_long_mean_hi_new<-bind_rows(data_plot_long_mean_hi, .id = 'scales')%>%rename("subgroup" = hh_inc_cur_3g)


export_shiny_data <- bind_rows(data_plot_long_mean_new, data_plot_long_mean_ge_new,data_plot_long_mean_ag_new,data_plot_long_mean_ed_new,data_plot_long_mean_bl_new,data_plot_long_mean_hi_new)


#combine shares and N to one dataframe
export_shiny_data <- left_join(export_shiny_data, data_plot_long_N_new,by=c("wavedate"="wavedate","variable"="variable","scales"="scales"))

#Round the data before exporting
export_shiny_data <- export_shiny_data %>% mutate(mean_measurement=round(mean_measurement,2),
                                                  mean_measurement_se=round(mean_measurement_se,2),
                                                  ymax=round(ymax,2),
                                                  ymin=round(ymin,2))

#MERGE LABELING of SCALES TO DATA

grouped_labels<-grouped_labels %>%rename(scales=ID)

#Remove "Number = " in labels of measurement
df<-df %>% mutate_all(~(gsub("^.*?= ","",.)))


grouped_labels2<-df %>%mutate(variable=rownames(.)) %>% left_join(grouped_labels,by = c("variable"))
grouped_labels2 <- grouped_labels2 %>% mutate(na=rowSums(is.na(.)))

grouped_labels2$wn <- apply(df=='Weiss nicht', 1, FUN= function(x) toString(names(na.omit(x))[na.omit(x)]))
grouped_labels2$ka <- apply(df=='keine Angabe', 1, FUN= function(x) toString(names(na.omit(x))[na.omit(x)]))
grouped_labels2$wn[grouped_labels2$wn==""]<-NA
grouped_labels2$ka[grouped_labels2$ka==""]<-NA
grouped_labels2 <- grouped_labels2 %>% mutate(scalenumber=12-na-(!is.na(wn))-(!is.na(ka)))

grouped_labels2$wn[is.na(grouped_labels2$wn)]<-"nown"
grouped_labels2$ka[is.na(grouped_labels2$ka)]<-"noka"
grouped_labels2$nown="no WN option"
grouped_labels2$noka="no KA option"

# count number of discrete values and WN/KA variable #TO DO##########################################

#combine shares and N to one dataframe
export_shiny_data_shares <- left_join(data_plot_long_new, data_plot_long_N_new,by=c("wavedate"="wavedate","variable"="variable","scales"="scales"))

#Round the data before exporting
export_shiny_data_shares <- export_shiny_data_shares %>% select(-c(n,n_se)) %>% mutate(prop=round(prop,3),
                                                                                       ymax=round(ymax,3),
                                                                                       ymin=round(ymin,3))

#Export the data
write_csv(export_shiny_data, "./output/tables/export_shiny_data.csv", na = "NA")
write_csv(export_shiny_data_shares, "./output/tables/export_shiny_data_shares.csv", na = "NA")
write_csv(grouped_labels2, "./output/tables/grouped_labels.csv", na = "NA")


#data_long$measurement<-as.factor(data_long$measurement)
#levels(data_long$variable) <- c("Ges. Gefahr Persönlich", "Ges. Gefahr Für die österr. Bevölkerung"," Wir. Gefahr Persönlich", "Wir. Gefahr Für die österr. Bevölkerung")

#levels(data_plot_long_mean$variable) <- c("Ges. Gefahr Persönlich", "Ges. Gefahr Für die österr. Bevölkerung"," Wir. Gefahr Persönlich", "Wir. Gefahr Für die österr. Bevölkerung")


```

```{r download and export covid19 cases, echo=FALSE, fig.width=8, fig.height=5, results='asis'}

epidf2 =            read.delim("https://covid19-dashboard.ages.at/data/CovidFaelle_Timeline.csv", sep=";", header=TRUE)

write_csv(epidf2, "./output/tables/CovidFaelle_Timeline.csv", na = "NA")

```

## Datawrapper

```{r example data export for gesundheitliche Gefahr, echo=FALSE, fig.width=8, fig.height=5, results='asis',include=FALSE}
#GESUNDHEITLICH#########################

lr_gen_w1 <- bern_data_long2_factored %>% filter(!is.na(WEIGHTD))

data_long <- gather(lr_gen_w1, condition, measurement, ges_per_gefahr:ges_pub_gefahr, factor_key=TRUE)
data_long$measurement<-as.factor(data_long$measurement)

data_plot_long_N<-data_long %>% filter(!is.na(measurement)) %>% 
 group_by(wave,condition) %>% tally()

data_plot_long<-data_long %>% filter(!is.na(measurement)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wave,condition,measurement) %>% 
  summarise(n=survey_total(vartype = c("se")))

data_plot_long<-data_plot_long %>% group_by(wave,condition) %>%
     mutate(prop = n/sum(n),ymax=prop+1.96*sqrt(n/sum(n))*(1-(n/sum(n)))/n, ymin=prop-1.96*sqrt(n/sum(n))*(1-(n/sum(n)))/n)

data_plot_long$wave<-as.factor(data_plot_long$wave)
levels(data_plot_long$wave) <-c("W1", "W2", "W3","W4","W5","W6","W7","W8","W9","W10","W11","W12","W13","W14","W15","W16","W17","W18","W19","W20","W21","W22","W23","W24")
levels(data_plot_long$condition) <- c("Persönlich", "Für die österr. Bevölkerung")
levels(data_plot_long$measurement) <- c("sehr groß", "groß", "mittelmäßig", "klein", "sehr klein")

data_plot_long$measurement <- fct_relevel(data_plot_long$measurement, "sehr klein", "klein", "mittelmäßig", "groß", "sehr groß")

#mean line attention recoding 5= sehr groß 1= sehr klein
data_plot_long_mean <- data_long  %>% filter(!is.na(measurement)) %>%
  as_survey_design(weights = c(WEIGHTD)) %>%
  group_by(wavedate,condition) %>%
  summarise(mean_measurement=survey_mean(6-as.numeric(measurement),vartype = c("se"))) %>% group_by(wavedate,condition) %>%
     mutate(ymax=mean_measurement+1.96*mean_measurement_se, ymin=mean_measurement-1.96*mean_measurement_se)

levels(data_plot_long_mean$condition) <- c("Persönlich", "Für die österr. Bevölkerung")

data_plot_long_mean_export <- data_plot_long_mean %>% 
  select(-c(mean_measurement_se)) %>%
  pivot_wider(id_cols = c(wavedate,condition),names_from=condition, values_from=c(mean_measurement,ymax,ymin), names_glue = "{condition}_{.value}")

data_plot_long_mean_export_rn <- data_plot_long_mean_export %>% ungroup() %>%
  rename("Persönlich"='Persönlich_mean_measurement',
         "Für die österr. Bevölkerung"='Für die österr. Bevölkerung_mean_measurement')

write_csv(data_plot_long%>%filter(condition=="Für die österr. Bevölkerung"), "./output/tables/figure1_shares.csv", na = "NA")
write_csv(data_plot_long_mean_export_rn, "./output/tables/figure1_mean.csv", na = "NA")
write_csv(data_plot_long_N, "./output/tables/figure1_observations.csv", na = "NA")
```



