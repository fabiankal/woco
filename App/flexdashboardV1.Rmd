---
title: "Work and Corona Dashboard"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r global, include=FALSE}
library(plotly)
library(tidyr)
library(dplyr)
library(rlang)
# load data in 'global' chunk so it can be shared by all users of the dashboard
data <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/export_shiny_data.csv")

data_shares <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/export_shiny_data_shares.csv")

my_autocomplete_list <- unique(data$variable)

```

Mean plots
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

Choose wisely.

```{r}
selectizeInput(
    inputId = 'variables',
    label = 'Variablen',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[1],
    multiple = TRUE, # allow for multiple inputs
    options = list(create = FALSE), # if TRUE, allows newly created inputs
  )
selectInput("groupby", label = "Gruppierung",
            choices = c("Keine","Gender", "Age", "Education", "Region","Income"), selected = "Keine")

checkboxInput(inputId = 'confidence', label = "95% Konfidenzintervalle", value = FALSE)
checkboxInput(inputId = 'incidence', label = "7-Tages Inzidenz", value = FALSE)
checkboxInput(inputId = 'relevantdates', label = "Relevante Ergeignisse", value = FALSE)

# sliderInput("bw_adjust", label = "Bandwidth adjustment:",
#             min = 0.2, max = 2, value = 1, step = 0.2)

```

Column
-----------------------------------------------------------------------

### Line Plot

```{r}

#output$out1 <- renderPrint(input$variables)
#verbatimTextOutput('out1')

# output$out1 <- renderPrint({data %>% select(wavedate,variable,mean_measurement,ymax_mean,ymin_mean) %>% 
#     distinct(wavedate,variable, .keep_all = TRUE) %>% 
#     filter(variable %in% input$variables) %>%  
#     pivot_wider(id_cols = c(wavedate,variable),names_from=variable, values_from=c(mean_measurement,ymax_mean,ymin_mean), names_glue = "{variable}_{.value}")})
# verbatimTextOutput('out1')

#eventReactive(input$groupby, { })

renderPlotly({
  data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin) %>%
    distinct(wavedate,variable, .keep_all = TRUE) %>%
    filter(variable %in% input$variables & groupby=="all") #%>%
    #pivot_wider(id_cols = c(wavedate,variable),names_from=variable, values_from=c(mean_measurement,ymax_mean,ymin_mean), names_glue = "{variable}_{.value}")

  p <- data2 %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~variable)
  p <- p %>% layout(title = "Average agreement",
         xaxis = list(title = ""),
         yaxis = list (title = ""),
         legend = list(orientation = 'h'))
  p
})

tags$a("The scale of this variable goes from ",tags$strong("X")," to.",tags$strong("Y"))


```

### By Group

```{r}
#output$out1 <- renderPrint(input$groupby)
#verbatimTextOutput('out1')

# data3 = data %>% select(wavedate,variable,groupby,subgroup,mean_measurement,ymax,ymin) %>%
#     filter(variable %in% test2) %>%
#     filter(case_when(test=="Gender"~ groupby=="ge",
#                test=="Age"~ groupby=="ag"))

renderPlotly({
  data3 = data %>% select(wavedate,variable,groupby,subgroup,mean_measurement,ymax,ymin) %>%
    filter(variable %in% input$variables[1]) %>%
    filter(case_when(input$groupby=="Gender"~ groupby=="ge",
                     input$groupby=="Age"~ groupby=="ag",
                     input$groupby=="Education"~ groupby=="ed",
                     input$groupby=="Region"~ groupby=="bl",
                     input$groupby=="Income"~ groupby=="hi"))

  p <- data3 %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter', mode = 'lines+markers',linetype=~subgroup)
  p <- p %>% layout(title = "Average agreement",
         xaxis = list(title = ""),
         yaxis = list (title = ""),
         legend = list(orientation = 'h'))
  p
})

```

Share plots
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

Choose wisely.

```{r}
selectInput(
    inputId = 'var_shares',
    label = 'Variablen',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[1],
    multiple = FALSE, # allow for multiple inputs
    #options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

```

Column
-----------------------------------------------------------------------

### To do

```{r}

renderPlotly({
  data3 = data_shares %>% select(wavedate,variable,measurement,prop) %>%
    filter(variable %in% input$var_shares) 
  
  p <- ggplot(data3, aes(fill=measurement,x=wavedate, y=prop)) + 
    geom_area(position="stack", show.legend = TRUE,stat = "identity",colour="white",alpha=.8) + #geom_bar width=0.7
    geom_point(position=position_stack(),colour="white") +
    #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
    scale_fill_brewer(palette = "RdYlBu", direction=1) +  #alternative:Blues
    labs(y = "Prozent", x= "",fill="") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_date(date_breaks = "2 month",date_labels = "%b-%y",guide = guide_axis(n.dodge = 2))
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 

  ggplotly(p)
  # p <- data3 %>%
  # plot_ly(x = ~wavedate, y= ~prop,type = 'bar',color = ~measurement,barmode = 'stack')
  # p <- p %>% layout(title = "Shares",
  #        xaxis = list(title = ""),
  #        yaxis = list (title = ""),
  #        legend = list(orientation = 'h'))
  
  
})

```