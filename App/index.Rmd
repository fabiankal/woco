---
title: "Work & Corona Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    theme: bootstrap
    orientation: columns
    favicon: www/favicon-32x32.png
    navbar:
      - {title: "Source Code", icon: "fa-github", href: "https://github.com/fabiankal/woco", target: "_blank",align: "right"}
      - {title: "", icon: "fa-twitter", href: "https://twitter.com/intent/tweet?text=Work+%26+Corona+Dashboard%3A+https%3A%2F%2Fwoco.univie.ac.at%2Fdashboard%2F", target: "_blank",align: "right"}
---

```{css, echo=FALSE}
/*change position of plotly modebar*/
.js-plotly-plot .plotly .modebar {
    left: 60%;
}
/*include a scrollbar in section anmerkungen*/
#section-anmerkungen
  .chart-shim {
    overflow-y: scroll;
    }
```

```{r setup, include=FALSE}
#runtime: shiny_prerendered
library(plotly)
library(tidyr)
library(dplyr)
library(stringr)
library(forcats)
library(base64enc)
library(flexdashboard)
library(readr)
library(shiny)
#library(rlang)
#library(bslib)
#library(htmlwidgets)

#get a reactive (text) variable
 myval3 <- reactiveValues()
```

```{r data, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard

githubdir <-"https://raw.githubusercontent.com/fabiankal/woco/master/"

#dashboard release version
version<-"V1.1" 

#data with variable means
data <-readr::read_csv(paste0(githubdir,"output/tables/export_shiny_data.csv"),show_col_types = FALSE)

#data with shares of answer categories
data_shares <-readr::read_csv(paste0(githubdir,"output/tables/export_shiny_data_shares.csv"),show_col_types = FALSE)

#variable labels
data_labels <-readr::read_csv(paste0(githubdir,"output/tables/data_labels_cq.csv"),show_col_types = FALSE)
data_labels$scalenumber=data_labels$scalenumber+1

#covid cases
epidf       <-readr::read_csv(paste0(githubdir,"output/tables/CovidFaelle_Timeline.csv"),show_col_types = FALSE)


#change some letters to german "umlaute"

data_labels$q_cate<-gsub(pattern = 'ae', replacement = "ä",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Ae', replacement = "Ä",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'ue', replacement = "ü",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Ue', replacement = "ü",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Daür', replacement = "Dauer",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Aktüll', replacement = "Aktuell",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'oe', replacement = "ö",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Oe', replacement = "Ö",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Depressivität', replacement = "Emotionen",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Neü', replacement = "Neue",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Steürn', replacement = "Steürn",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Fraün', replacement = "Frauen",data_labels$q_cate)

data_labels$labels<-gsub(pattern = 'ae', replacement = "ä",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Ae', replacement = "Ä",data_labels$labels)
data_labels$labels<-gsub(pattern = 'ue', replacement = "ü",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Ue', replacement = "ü",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Daür', replacement = "Dauer",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Aktüll', replacement = "Aktuell",data_labels$labels)
data_labels$labels<-gsub(pattern = 'oe', replacement = "ö",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Oe', replacement = "Ö",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Depressivität', replacement = "Emotionen",data_labels$labels)
data_labels$labels<-gsub(pattern = 'CafÃ©s', replacement = "Cafés",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Neü', replacement = "Neue",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Steürn', replacement = "Steuern",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Fraün', replacement = "Frauen",data_labels$labels)


data_labels <- data_labels %>% filter(!is.na(labels))


#Transform variables to list to add categorization
xy.list <- split(data_labels$q_cate,data_labels$q_cate) 
 
 for (val in unique(data_labels$q_cate)) {
 xy.list[[val]] <- data_labels %>% filter(q_cate==val) %>% pull(variable,labels) 
 }

my_autocomplete_list <- xy.list

#important dates during the COVID-19 pandemic
hlinedata = data.frame(x = c("16.03.2020",
                             "14.04.2020",
                             "15.05.2020",
                             "15.06.2020",
                             "24.07.2020",
                             "21.09.2020",
                             "03.11.2020",
                             "17.11.2020",
                             "07.12.2020",
                             "26.12.2020",
                             "25.01.2021",
                             "08.02.2021",
                             "01.04.2021",
                             "03.05.2021",
                             "19.05.2021",
                             "01.07.2021",
                             "15.09.2021",
                             "22.11.2021"),
                     label_en=c("Lockdown",
                             "Easing of\nmeasurments",
                             "Reopening\nrestaurants",
                             "Easing of mask rules",
                             "Mask rules\nnew",
                             "Closing hour",
                             "Nightly\ncurfew",
                             "Lockdown\n",
                             "Reop.\ncommerce",
                             "Lock-\ndown",
                             "FFP2-\nmasks",
                             "Reopening",
                             "Lockdown\neast",
                             "Reopening\neast",
                             "Reopening",
                             "Easing of mask rules",
                             "FFP2-\nmasks",
                             "Lockdown"),
                      label_de=c("Lockdown",
                             "Erste\nÖffnungen",
                             "Gastro-\nöffnung",
                             "Lockerung\nMasken",
                             "Maskenpflicht\nneu",
                             "Sperrstunde",
                             "Ausgangs-\nbeschr.",
                             "Lockdown",
                             "Öffnung\nHandel",
                             "Lockdown",
                             "FFP2-\nMasken",
                             "Öffnung",
                             "Lockdown\nOst",
                             "Öffnung\nOst",
                             "Öffnung",
                             "Lockerung\nMasken",
                             "FFP2-\nMasken",
                             "Lockdown"),
                       y = c(1.1,1.1,1.1,1.1,1.1,
                             1.1,1.1,1.1,1.1,1.1,
                             1.1,1.1,1.1,1.1,1.1,
                             1.1,1.1,1.1))

hlinedata$x<-as.Date(hlinedata$x,"%d.%m.%Y")

#Filter and recode covid 19 cases

epidf_rc = epidf %>% filter(BundeslandID==10) %>% rename(daily_inf = names(epidf)[5],
                                                         daily_inf_7T = names(epidf)[7])

epidf_rc$time = as.Date(str_split(string = epidf_rc$Time, 
                        pattern = "[[:space:]]", 
                        simplify = TRUE)[, 1],
                        "%d.%m.%Y")

#reorder factor levels for the subgroup means 
data$subgroup<-as.factor(data$subgroup)
data$subgroup<-fct_relevel(data$subgroup,"<30","30-59",">60","1-3.Decile","4-7.Decile","8-10.Decile","primary","Lehre","secondary","tertiary","<10.000","10.000–1 Million",">1 Million","female","male","Arbeitend","in Home-office","in Kurzarbeit","Arbeitslos","Nicht-Arbeitend","none")
levels(data$subgroup)<- c("<30","30-59",">60","gering (1.-3. Dezil)","mittel (4.-7. Dezil)"," hoch (8.-10. Dezil)",
                          "primär","Lehre","sekundär","tertiär","<10.000","10.000–1 Million",
                          ">1 Million","weiblich","männlich","Arbeitend","in Home-office","in Kurzarbeit",
                          "Arbeitslos","Nicht-Arbeitend","keine")

#umlaute for data shares
data_shares$measurement<-gsub(pattern = 'ae', replacement = "ä",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'ue', replacement = "ü",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'Ue', replacement = "Ü",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'oe', replacement = "ö",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_shares$measurement)

#reorder measurement so that 10 is not between 1 and 2
data_shares$measurement<-as.factor(data_shares$measurement)
data_shares$measurement<-fct_relevel(data_shares$measurement,"10 = äusserst zufrieden",after = Inf)
data_shares$measurement<-fct_relevel(data_shares$measurement,"10 = Sehr viel Vertrauen",after = Inf)

```

Verteilung der Antworten {data-icon="fa-area-chart"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------

```{r}

#Create intro text with Dynamic link to the questionnaire
output$link <- renderUI({
       icons <-HTML(paste0('<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable aus, die Sie anzeigen möchten. (Infos zu den Variablen finden Sie <a href="https://woco.univie.ac.at/dashboard/variablen/?',page(),'" target="_blank">hier</a>)'))
       tagList(tags$br(),icons)
    })

#Dynamic link display
uiOutput("link",inline=TRUE)

#Variable selection element
selectizeInput(
    inputId = 'var_shares',
    label = 'Variable auswählen:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[10]][3],
    multiple = TRUE, # allow for multiple inputs
    options = list(create = FALSE,maxItems = 1)
  )

#Choose page = variable category for the link to the questionnaire
page <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$var_shares]," ",simplify = TRUE)[1])

#Color direction selection element
checkboxInput(inputId = 'colordirect', label = "Farbschema umkehren", value = FALSE)

#Add information if variable is only available for a subgroup of the respondents
filterinfo <- reactive(data_labels$q_filt[data_labels$variable %in% input$var_shares])

output$info <- renderUI({
       if(filterinfo()=="no") {
         infotext2 <- HTML(paste0(''))
         tagList(infotext2,tags$br(),tags$br())
       }
       else {
         infotext1 <- HTML(paste0('<i class="fa fa-exclamation-triangle"></i> Diese Frage wurde nur an Personen gestellt wo:<br>',filterinfo(),'.'))
         tagList(infotext1,tags$br(),tags$br())
        }
    })
#Output text information about potential filters
uiOutput("info",inline=TRUE)

#uiOutput("downloadUI") #html download button for future use

#Display information about the dashboard
HTML(paste0(
        "<div style='position: absolute; bottom: 5px; right: 10px; text-align: right; font-size: 1.75ex'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/"  target="_blank">CC BY 3.0 AT</a>
        </div>'
        ))
```

Column
-----------------------------------------------------------------------

### Anteile der Antwortkategorien in % aller gültigen Antworten nach Befragungswelle {.no-mobile data-height=1000}

```{r,context="server"}

#output$out1 <- renderPrint(as.numeric(input$colordirect)) test output for debugging
#verbatimTextOutput('out1')

#session_store <- reactiveValues() #html download for future use

#create Plotly output

renderPlotly({
  # get variable that should be displayed
  inputvariable_shares <- data_labels$variable[data_labels$variable %in% input$var_shares]
  
  # select data and rename variables
  data3 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>%
    filter(variable %in% inputvariable_shares) 
  data3 <- data3 %>% mutate(Personen = round(prop*N_total,0)) %>% rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total)
  
  #calculate N
  Nrund<-round(mean(data3$N,na.rm=TRUE),0)
  
  #create graph with ggplot
  p <- ggplot(data3, aes(fill=Kategorie,x=Datum, y=Anteil)) + 
    geom_area(position="stack", show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + 
    geom_point(aes(text=paste("N (Welle): ",N)),position=position_stack(),colour="white") +
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect)*2)-1)) + 
    labs(y = "", x= "",fill="") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_date(date_breaks = "2 month",date_labels = "%b %y",guide = guide_axis(n.dodge = 2))
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 
  
  #increase size (margin) around the plot to fit the logo and information about the data source and N
m <- list(l = 0,r = 0,b = 80,t = 20,pad = 4)  
  
  #transform the ggplot t plotly and display the graph
  g <- ggplotly(p,tooltip = c("x","y","fill","text"),dblclick = FALSE) %>%
layout(legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045,tracegroupgap = 0),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 1, y = -0.17, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.13, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  #g$x$data[[1]]$hoverinfo <- "none" # necessary if hoverCompareCartesian should be used
  #g$x$data[[2]]$hoverinfo <- "none"
  #g$x$data[[3]]$hoverinfo <- "none"
  #g$x$data[[4]]$hoverinfo <- "none"
  #g$x$data[[5]]$hoverinfo <- "none"
  #session_store$plt<-g #html download for future use
  g
  
})

#html download for future use
# output$downBtn  <- downloadHandler(
#         filename = function() {
#             paste("data-", Sys.Date(), ".html", sep = "")
#         },
#         content = function(file) {
#             # export plotly html widget as a temp file to download.
#             saveWidget(as_widget(session_store$plt), file, selfcontained = TRUE)
#         }
#     )
# 
# # Create the actual downloadButton
# output$downloadUI <- renderUI( {
#   downloadButton("downBtn", "Download Graph as html", style = "width:100%;")
# })

```

### Anteile der Antwortkategorien in % aller gültigen Antworten nach Befragungswelle {.mobile}

```{r,context="server"}

#output$out1 <- renderPrint(as.numeric(input$colordirect))
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariable_shares <- data_labels$variable[data_labels$variable %in% input$var_shares]
  
  data3 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>%
    filter(variable %in% inputvariable_shares) 
  data3 <- data3 %>% mutate(Personen = round(prop*N_total,0)) %>% rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total)
  
  Nrund<-round(mean(data3$N,na.rm=TRUE),0)
  
  p <- ggplot(data3, aes(fill=Kategorie,x=Datum, y=Anteil)) + 
    geom_area(position="stack", show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + #geom_bar width=0.7
    geom_point(aes(text=paste("N (Welle): ",N)),position=position_stack(),colour="white") +
    #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect)*2)-1)) +  #alternative:Blues
    labs(y = "", x= "",fill="") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_date(date_breaks = "3 month",date_labels = "%b\n%y",guide = guide_axis(n.dodge = 2))
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 

  
m <- list(l = 0,r = 0,b = 110,t = 20,pad = 4)  

  g <- ggplotly(p,tooltip = c("x","y","fill","text"),dblclick = FALSE) %>%
layout(legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.11,tracegroupgap = 0),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 1, y = -0.34, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.30, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  #g$x$data[[1]]$hoverinfo <- "none"
  #g$x$data[[2]]$hoverinfo <- "none"
  #g$x$data[[3]]$hoverinfo <- "none"
  #g$x$data[[4]]$hoverinfo <- "none"
  #g$x$data[[5]]$hoverinfo <- "none"
  g
})

```


Mittelwerte {data-icon="fa-line-chart"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------

```{r}

#Dynamic link creation
output$link2 <- renderUI({
       icons <-HTML(paste0('<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable(n) aus, die Sie anzeigen möchten. (Infos zu den Variablen finden Sie <a href="https://woco.univie.ac.at/dashboard/variablen/?',page2(),'" target="_blank">hier</a>)'))
       #url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page()),target="_blank")
       tagList(tags$br(),icons)
    })

#Dynamic link display
uiOutput("link2",inline=TRUE)

selectizeInput(
    inputId = 'variables',
    label = 'Variable(n) auswählen:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[10]][3:4],
    multiple = TRUE, # allow for multiple inputs
    options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

#Choose Page
page2 <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$variables]," ",simplify = TRUE)[1])

checkboxInput(inputId = 'confidence', label = "95% Konfidenzintervalle", value = FALSE)
checkboxInput(inputId = 'incidence', label = "7-Tages Inzidenz", value = FALSE)
checkboxInput(inputId = 'relevantdates', label = "Relevante Ergeignisse", value = FALSE)
checkboxInput(inputId = 'axis0', label = "Minimalwert der Y-Achse bei 0 fixieren", value = TRUE)

filterinfo2 <- reactive(data_labels$q_filt[data_labels$variable %in% input$variables[1]])

output$info2 <- renderUI({
       if(filterinfo2()=="no") {
         infotext2 <- HTML(paste0(''))
         tagList(infotext2,tags$br(),tags$br())
       }
       else {
         infotext1 <- HTML(paste0('<i class="fa fa-exclamation-triangle"></i> Die Frage der 1. Variable wurde nur an Personen gestellt wo:<br>',filterinfo2(),'.'))
         tagList(infotext1,tags$br(),tags$br())
        }
    })

uiOutput("info2",inline=TRUE)

version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px; right: 10px; text-align: right; font-size: 1.75ex'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/"  target="_blank">CC BY 3.0 AT</a>
        </div>'
        ))
```

Column
-----------------------------------------------------------------------

### Mittelwerte nach Befragungswelle {.no-mobile data-height=800}

```{r,context="server"}

#output$out1 <- renderPrint(input$relevantdates)
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariables <- data_labels$variable[data_labels$variable %in% input$variables]
  
  data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales,N_total) %>%
    distinct(wavedate,variable, .keep_all = TRUE) %>%
    filter(variable %in% inputvariables & groupby=="all") %>% left_join(data_labels,by=c("variable"))%>%
    mutate(y_err=ymax-mean_measurement)
  
  Nrund<-round(mean(data2$N_total,na.rm=TRUE),0)
  m <- list(l = 0,r = 0,b = 80,t = 20,pad = 4)  

  if(input$confidence)
  {
  p <- data2[order(data2$labels),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~labels,
          error_y = ~list(array = y_err))
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis0,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.94,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.13, text = paste("Daten: ACPP + WoCo.","N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    # layout(annotations = 
    #         list(x = 1, y = -0.16, text = paste("N ~",Nrund,"pro Welle"), 
    #         showarrow = F, xref='paper', yref='paper', 
    #         xanchor='right', yanchor='auto', xshift=0, yshift=0,
    #         font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
  else
  {
  p <- data2[order(data2$labels),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~labels)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis0,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.93,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.13, text = paste("Daten: ACPP + WoCo.","N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    #layout(annotations = 
    #        list(x = 1, y = -0.12, text = paste("N ~",Nrund,"pro Welle"), 
    #        showarrow = F, xref='paper', yref='paper', 
    #        xanchor='right', yanchor='auto', xshift=0, yshift=0,
    #       font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
 
  if(input$relevantdates)
  {
    vline_list <- list()
    vanno_list <- list()
    for(i in 1:length(hlinedata$x))
      {
        vline_list[[i]] <-list(type      = "line",
                               line      = list(color="black",dash="dash"),
                               opacity   = 0.3,
                               x0        = hlinedata$x[i],
                               x1        = hlinedata$x[i],
                               xref      = "x",
                               y0        = ifelse(input$axis0,0,min(data2$mean_measurement))*0.96,
                               y1        = max(data2$mean_measurement)*1+(((i+1)%%2)*-0.11),
                               yref      = "y")
  
        vanno_list[[i]] <- list(x = hlinedata$x[i],
                                y = max(data2$mean_measurement)*1.02+(((i+1)%%2)*-0.11),
                                text = hlinedata$label_de[i],
                                xref = "x",
                                yref = "y",
                                showarrow = FALSE,
                                arrowhead = 7,
                                ax = 0,
                                ay = 10,
                                font=list(size=9))
    }
    p <- p %>%  layout(shapes  = vline_list,annotations = vanno_list)
  }
  if(input$incidence)
  {
    p <- p  %>% add_trace(x = ~epidf_rc$time, y = ~round((epidf_rc$daily_inf_7T*0.01123461),1), type = 'scatter', mode = 'none', name = '7-Tage Inzidenz',yaxis = "y2", fill = 'tozeroy', inherit = FALSE) %>% layout(yaxis2 = list(overlaying = "y", side = "right",showgrid = F),margin = list(r=35))
  
  }
  
  p
  
})

```

### Mittelwerte nach Befragungswelle {.mobile}

```{r,context="server"}

#output$out1 <- renderPrint(input$relevantdates)
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariables <- data_labels$variable[data_labels$variable %in% input$variables]
  
  data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales,N_total) %>%
    distinct(wavedate,variable, .keep_all = TRUE) %>%
    filter(variable %in% inputvariables & groupby=="all") %>% left_join(data_labels,by=c("variable"))%>%
    mutate(y_err=ymax-mean_measurement)
  
  Nrund<-round(mean(data2$N_total,na.rm=TRUE),0)
  m <- list(l = 0,r = 0,b = 80,t = 20,pad = 4)  

  if(input$confidence)
  {
  p <- data2[order(data2$labels),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~labels,
          error_y = ~list(array = y_err))
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis0,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.94,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.13, text = paste("Daten: ACPP + WoCo.","N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
  else
  {
  p <- data2[order(data2$labels),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~labels)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis0,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.93,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.13, text = paste("Daten: ACPP + WoCo.","N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
 
  if(input$relevantdates)
  {
    vline_list <- list()
    vanno_list <- list()
    for(i in 1:length(hlinedata$x))
      {
        vline_list[[i]] <-list(type      = "line",
                               line      = list(color="black",dash="dash"),
                               opacity   = 0.3,
                               x0        = hlinedata$x[i],
                               x1        = hlinedata$x[i],
                               xref      = "x",
                               y0        = ifelse(input$axis0,0,min(data2$mean_measurement))*0.96,
                               y1        = max(data2$mean_measurement)*1+(((i+1)%%2)*-0.11),
                               yref      = "y")
  
        vanno_list[[i]] <- list(x = hlinedata$x[i],
                                y = max(data2$mean_measurement)*1.02+(((i+1)%%2)*-0.11),
                                text = hlinedata$label_de[i],
                                xref = "x",
                                yref = "y",
                                showarrow = FALSE,
                                arrowhead = 7,
                                ax = 0,
                                ay = 10,
                                font=list(size=9))
    }
    p <- p %>%  layout(shapes  = vline_list,annotations = vanno_list)
  }
  if(input$incidence)
  {
    p <- p  %>% add_trace(x = ~epidf_rc$time, y = ~round((epidf_rc$daily_inf_7T*0.01123461),1), type = 'scatter', mode = 'none', name = '7-Tage Inzidenz',yaxis = "y2", fill = 'tozeroy', inherit = FALSE) %>% layout(yaxis2 = list(overlaying = "y", side = "right",showgrid = F),margin = list(r=35))
  
  }
  
  p
  
})

```

### anmerkungen {.no-title data-height=150}
```{r,context="server"}
#output$out1 <- renderPrint(input$variables)
#verbatimTextOutput('out1')

#get a reactive (text) variable
myval <- reactiveValues()

 #Observe changes in variables (will run when variables change)
  observeEvent(input$variables, {
    
    inputvariables <- data_labels$variable[data_labels$variable %in% input$variables]
    
    data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales) %>%
    distinct(wavedate,variable, .keep_all = TRUE) %>%
    filter(variable %in% inputvariables & groupby=="all") 
  
  variables=0
  labels_st=0
  labels_en=0
  labels_ms=0
  labeln_st=0
  labeln_en=0
  text=0
  k=0
  
data_labels$wn[is.na(data_labels$wn)]<-"nown"
data_labels$ka[is.na(data_labels$ka)]<-"noka"
data_labels$nown=NA
data_labels$noka=NA



  for(i in unique(data2$scales))
      {
      k=k+1
       variables[k]=paste(data_labels$labels[data_labels$variable %in% unique(data2$variable[data2$scales==i])],collapse='", "')
       labeln_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(V1) %>% distinct(),sep=", ",collapse=", ")
       labeln_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(max) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(paste('V',data_labels %>% filter(scales==i) %>% select(scalenumber) %>% distinct(),sep="")) %>%
                            distinct(),sep=", ",collapse=", ")
       labels_ms[k]=gsub('NA", "',"",paste(data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(wn) %>% distinct())) %>% 
                            distinct(),
                          data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(ka) %>% distinct())) %>% 
                            distinct(),
                          sep='", "'))
       if(data_labels %>% filter(scales==i) %>% select(rev) %>% distinct()=="0") 
         {
         text[k]=paste('&bull; Die Skala der Variable(n)', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_st[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_en[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
       else
         {
         text[k]=paste('&bull; Die Skala der Variable(n)', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_en[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_st[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
  }
   if(k>1) text[1] = paste('<i class="fa fa-exclamation-triangle"></i> Achtung: Variablen mit unterschiedlichen Skalen ausgewählt.<br/>',text[1])
    
     myval$calc <- text #write text in dynamic variable

  })

output$selected_var <- renderUI({
   HTML(paste(myval$calc, collapse="<br/>"))
  })

htmlOutput("selected_var")

```

Gruppierte Mittelwerte {data-icon="fa-users"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------


```{r}

#Dynamic link creation
output$link3 <- renderUI({
       icons <-HTML(paste0('<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable aus, die Sie anzeigen möchten. (Infos zu den Variablen finden Sie <a href="https://woco.univie.ac.at/dashboard/variablen/?',page3(),'" target="_blank">hier</a>)'))
       #url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page()),target="_blank")
       tagList(tags$br(),icons)
    })

#Dynamic link display
uiOutput("link3",inline=TRUE)

selectizeInput(
    inputId = 'variablesgr',
    label = 'Variable auswählen:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[10]][3] ,
    multiple = FALSE, # allow for multiple inputs
    options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

#Choose Page
page3 <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$variablesgr]," ",simplify = TRUE)[1])

selectInput("groupby", label = "Gruppieren nach:",
            choices = c("Keine","Geschlecht", "Alter", "Bildungsgrad", "Einwohnerzahl","Einkommen","Arbeitsmarktstatus"), selected = "Geschlecht")

checkboxInput(inputId = 'confidence2', label = "95% Konfidenzintervalle", value = FALSE)
checkboxInput(inputId = 'incidence2', label = "7-Tages Inzidenz", value = FALSE)
checkboxInput(inputId = 'relevantdates2', label = "Relevante Ergeignisse", value = FALSE)
checkboxInput(inputId = 'axis02', label = "Minimalwert der Y-Achse bei 0 fixieren", value = TRUE)

filterinfo3 <- reactive(data_labels$q_filt[data_labels$variable %in% input$variablesgr])

output$info3 <- renderUI({
       if(filterinfo3()=="no") {
         infotext2 <- HTML(paste0(''))
         tagList(infotext2,tags$br(),tags$br())
       }
       else {
         infotext1 <- HTML(paste0('<i class="fa fa-exclamation-triangle"></i> Diese Frage wurde nur an Personen gestellt wo:<br>',filterinfo3(),'.'))
         tagList(infotext1,tags$br(),tags$br())
        }
    })

uiOutput("info3",inline=TRUE)

version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px; right: 10px; text-align: right; font-size: 1.75ex'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/"  target="_blank">CC BY 3.0 AT</a>
        </div>'
        ))
```

Column
-----------------------------------------------------------------------

### Mittelwerte nach Befragungswelle und Subgruppe {.no-mobile data-height=800}

```{r,context="server"}
#output$out1 <- renderPrint(input$groupby)
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariables <- data_labels$variable[data_labels$variable %in% input$variablesgr]

  data3 = data %>% select(wavedate,variable,groupby,subgroup,mean_measurement,ymax,ymin,mean_tot,N_total) %>%
    filter(variable %in% inputvariables[1]) %>%
    filter(case_when(input$groupby=="Keine"~ groupby=="all",
                     input$groupby=="Geschlecht"~ groupby=="ge",
                     input$groupby=="Alter"~ groupby=="ag",
                     input$groupby=="Bildungsgrad"~ groupby=="ed",
                     input$groupby=="Einwohnerzahl"~ groupby=="bl",
                     input$groupby=="Einkommen"~ groupby=="hi",
                     input$groupby=="Arbeitsmarktstatus"~ groupby=="es")) %>%
    mutate(y_err=ymax-mean_measurement)
  
  data3$subgroup<-as.factor(data3$subgroup)
  data3$subgroup<-droplevels(data3$subgroup)
  
  Nrund<-round(mean(data3%>%group_by(wavedate)%>%summarise(N=sum(mean_tot,na.rm=TRUE))%>%pull(N),na.rm=TRUE),0)
  m <- list(l = 0,r = 0,b = 80,t = 20,pad = 4)
  
  if(input$confidence2)
  {
  p <- data3[order(data3$subgroup),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~subgroup, 
          error_y = list(array = ~y_err))#,
          #sort = FALSE)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis02,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.94,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.18, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.13, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
  else
  {
  p <- data3[order(data3$subgroup),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter', mode = 'lines+markers',linetype=~subgroup)#,
          #sort = FALSE)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis02,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.93,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.16, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.11, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
  if(input$relevantdates2)
  {
    vline_list <- list()
    vanno_list <- list()
    for(i in 1:length(hlinedata$x))
      {
        vline_list[[i]] <-list(type      = "line",
                               line      = list(color="black",dash="dash"),
                               opacity   = 0.3,
                               x0        = hlinedata$x[i],
                               x1        = hlinedata$x[i],
                               xref      = "x",
                               y0        = ifelse(input$axis02,0,min(data3$mean_measurement))*0.96,
                               y1        = max(data3$mean_measurement)*1+(((i+1)%%2)*-0.11),
                               yref      = "y")
  
        vanno_list[[i]] <- list(x = hlinedata$x[i],
                                y = max(data3$mean_measurement)*1.02+(((i+1)%%2)*-0.11),
                                text = hlinedata$label_de[i],
                                xref = "x",
                                yref = "y",
                                showarrow = FALSE,
                                arrowhead = 7,
                                ax = 0,
                                ay = 10,
                                font=list(size=9))
    }
    p <- p %>%  layout(shapes  = vline_list,annotations = vanno_list)
  }
  if(input$incidence2)
  {
    p <- p %>% add_trace(x = ~epidf_rc$time, y = ~round((epidf_rc$daily_inf_7T*0.01123461),1), type = 'scatter', mode = 'none', name = '7-Tage Inzidenz',yaxis = "y2", fill = 'tozeroy', inherit = FALSE) %>% layout(yaxis2 = list(overlaying = "y", side = "right",showgrid = F),margin = list(r=35))
  }

  p
})

```

### Mittelwerte nach Befragungswelle und Subgruppe {.mobile}

```{r,context="server"}
#output$out1 <- renderPrint(input$groupby)
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariables <- data_labels$variable[data_labels$variable %in% input$variablesgr]

  data3 = data %>% select(wavedate,variable,groupby,subgroup,mean_measurement,ymax,ymin,mean_tot,N_total) %>%
    filter(variable %in% inputvariables[1]) %>%
    filter(case_when(input$groupby=="Keine"~ groupby=="all",
                     input$groupby=="Geschlecht"~ groupby=="ge",
                     input$groupby=="Alter"~ groupby=="ag",
                     input$groupby=="Bildungsgrad"~ groupby=="ed",
                     input$groupby=="Einwohnerzahl"~ groupby=="bl",
                     input$groupby=="Einkommen"~ groupby=="hi",
                     input$groupby=="Arbeitsmarktstatus"~ groupby=="es")) %>%
    mutate(y_err=ymax-mean_measurement)
  
  data3$subgroup<-as.factor(data3$subgroup)
  data3$subgroup<-droplevels(data3$subgroup)
  
  Nrund<-round(mean(data3%>%group_by(wavedate)%>%summarise(N=sum(mean_tot,na.rm=TRUE))%>%pull(N),na.rm=TRUE),0)
  
  m <- list(l = 0,r = 0,b = 80,t = 20,pad = 4)
  
  if(input$confidence2)
  {
  p <- data3[order(data3$subgroup),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~subgroup, 
          error_y = list(array = ~y_err))#,
          #sort = FALSE)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis02,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.94,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.18, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.13, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
  else
  {
  p <- data3[order(data3$subgroup),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter', mode = 'lines+markers',linetype=~subgroup)#,
          #sort = FALSE)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis02,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.93,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.18, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.13, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  }
  if(input$relevantdates2)
  {
    vline_list <- list()
    vanno_list <- list()
    for(i in 1:length(hlinedata$x))
      {
        vline_list[[i]] <-list(type      = "line",
                               line      = list(color="black",dash="dash"),
                               opacity   = 0.3,
                               x0        = hlinedata$x[i],
                               x1        = hlinedata$x[i],
                               xref      = "x",
                               y0        = ifelse(input$axis02,0,min(data3$mean_measurement))*0.96,
                               y1        = max(data3$mean_measurement)*1+(((i+1)%%2)*-0.11),
                               yref      = "y")
  
        vanno_list[[i]] <- list(x = hlinedata$x[i],
                                y = max(data3$mean_measurement)*1.02+(((i+1)%%2)*-0.11),
                                text = hlinedata$label_de[i],
                                xref = "x",
                                yref = "y",
                                showarrow = FALSE,
                                arrowhead = 7,
                                ax = 0,
                                ay = 10,
                                font=list(size=9))
    }
    p <- p %>%  layout(shapes  = vline_list,annotations = vanno_list)
  }
  if(input$incidence2)
  {
    p <- p %>% add_trace(x = ~epidf_rc$time, y = ~round((epidf_rc$daily_inf_7T*0.01123461),1), type = 'scatter', mode = 'none', name = '7-Tage Inzidenz',yaxis = "y2", fill = 'tozeroy', inherit = FALSE) %>% layout(yaxis2 = list(overlaying = "y", side = "right",showgrid = F),margin = list(r=35))
  }

  p
})

```

### anmerkungen2 {.no-title data-height=150}

```{r,context="server"}
 #output$out1 <- renderPrint(input$variables)
 #verbatimTextOutput('out1')
 
 #get a reactive (text) variable
 myval2 <- reactiveValues()
 
  #Observe changes in variables (will run when variables change)
   observeEvent(input$variablesgr, {
     
     inputvariables <- data_labels$variable[data_labels$variable %in% input$variablesgr]
     
     data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales) %>%
     distinct(wavedate,variable, .keep_all = TRUE) %>%
     filter(variable %in% inputvariables & groupby=="all") 
 
   variables=0
   labels_st=0
   labels_en=0
   labels_ms=0
   labeln_st=0
   labeln_en=0
   text=0
   k=0
  
 data_labels$wn[is.na(data_labels$wn)]<-"nown"
 data_labels$ka[is.na(data_labels$ka)]<-"noka"
 data_labels$nown=NA
 data_labels$noka=NA
   

  for(i in unique(data2$scales))
      {
      k=k+1
       variables[k]=paste(data_labels$labels[data_labels$variable %in% unique(data2$variable[data2$scales==i])],collapse='", "')
       labeln_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(V1) %>% distinct(),sep=", ",collapse=", ")
       labeln_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(max) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(paste('V',data_labels %>% filter(scales==i) %>% select(scalenumber) %>% distinct(),sep="")) %>%
                            distinct(),sep=", ",collapse=", ")
       labels_ms[k]=gsub('NA", "',"",paste(data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(wn) %>% distinct())) %>% 
                            distinct(),
                          data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(ka) %>% distinct())) %>% 
                            distinct(),
                          sep='", "'))
       if(data_labels %>% filter(scales==i) %>% select(rev) %>% distinct()=="0") 
         {
         text[k]=paste('&bull; Die Skala der Variable', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_st[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_en[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
       else
         {
         text[k]=paste('&bull; Die Skala der Variable', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_en[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_st[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
  }
   if(k>1) text[1] = paste('<i class="fa fa-exclamation-triangle"></i> Achtung: Variablen mit unterschiedlichen Skalen ausgewählt.<br/>',text[1])
    
     myval2$calc <- text #write text in dynamic variable

  })
 
 output$selected_var2 <- renderUI({
    HTML(paste(myval2$calc, collapse="<br/>"))
   })
 
 htmlOutput("selected_var2")

```

Querschnitte {data-icon="fa-bar-chart"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------

```{r}

#Dynamic link creation
output$link4 <- renderUI({
       icons <-HTML(paste0('<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable aus, die Sie anzeigen möchten. (Infos zu den Variablen finden Sie <a href="https://woco.univie.ac.at/dashboard/variablen/?',page4(),'" target="_blank">hier</a>)'))
       #url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page()),target="_blank")
       tagList(tags$br(),icons)
    })

#Dynamic link display
uiOutput("link4",inline=TRUE)

selectInput(
    inputId = 'var_shares2',
    label = 'Variable auswählen:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[10]][3],
    multiple = FALSE, # allow for multiple inputs
    #options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

#Choose Page
page4 <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$var_shares2]," ",simplify = TRUE)[1])

selectInput(
    inputId = 'waves',
    label = 'Umfrage-Welle: (mittleres Befragungsdatum in Klammern)',
    choices = "1",
    selected = "1",
    multiple = FALSE, # allow for multiple inputs
    #options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

checkboxInput(inputId = 'colordirect2', label = "Farbschema umkehren", value = FALSE)

checkboxInput(inputId = 'play', label = "Wellen dynamisch abspielen (BETA)", value = FALSE)

filterinfo4 <- reactive(data_labels$q_filt[data_labels$variable %in% input$var_shares2])

output$info4 <- renderUI({
       if(filterinfo4()=="no") {
         infotext2 <- HTML(paste0(''))
         tagList(infotext2,tags$br(),tags$br())
       }
       else {
         infotext1 <- HTML(paste0('<i class="fa fa-exclamation-triangle"></i> Diese Frage wurde nur an Personen gestellt wo:<br>',filterinfo4(),'.'))
         tagList(infotext1,tags$br(),tags$br())
        }
    })

uiOutput("info4",inline=TRUE)

version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px; right: 10px; text-align: right; font-size: 1.75ex'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/"  target="_blank">CC BY 3.0 AT</a>
        </div>'
        ))
```


Column
-----------------------------------------------------------------------

### Anteile der Antwortkategorien in % aller gültigen Antworten {.no-mobile data-height=1000}

```{r,context="server"}
#output$out1 <- renderPrint(input$var_shares2)
#verbatimTextOutput('out1')

 #Observe changes in variables (will run when variables change)
 

renderPlotly({
  
   inputvariable_shares <- data_labels$variable[data_labels$variable %in% input$var_shares2]
 
   if(input$play==FALSE) 
   {
  data3 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% group_by(wavedate) %>%
     mutate(wave = cur_group_id()) %>% ungroup() %>%
    filter(variable %in% inputvariable_shares & wave %in% str_split(input$waves,pattern=" ",simplify = TRUE)[2])
  data3 <- data3 %>% mutate(Personen = round(prop*N_total,0)) %>% 
                     rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total) %>% 
    mutate(Kategoriex = if_else(row_number() %% 2 == 0, paste0("\n",Kategorie), as.character(Kategorie)))
  
  Nrund<-round(mean(data3$N,na.rm=TRUE),0)
  
  p <- ggplot(data3, aes(fill=Kategorie,x=Kategorie, y=Anteil,text=paste("N:",Nrund))) + 
    geom_bar(show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + 
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  
    labs(y = "", x= "",fill="") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2))+
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 
  
  m <- list(l = 40,r = 40,b = 80,t = 20,pad = 4)
  
  g <- ggplotly(p,tooltip = c("frame","x","y","text"))  %>% layout(barmode = "dodge") %>%
layout(showlegend = FALSE,
         xaxis = list(ticktext=~Kategoriex),
         legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 1, y = -0.17, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.12, text = paste("N =",Nrund,""), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
   }
 if(input$play==TRUE)
  {
  data4 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% 
    filter(variable %in% inputvariable_shares) %>% filter(!is.na(measurement))
  data4 <- data4 %>% mutate(Personen = round(prop*N_total,0)) %>% 
                     rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total) %>% 
    mutate(Kategoriex = if_else(row_number() %% 2 == 0, paste0("\n",Kategorie), as.character(Kategorie)),
           Kategorie2 = as.factor(Kategorie),
           Kategorie3 = as.numeric(Kategorie),
           dummy = "a")
  
  Nrund<-round(mean(data4$N,na.rm=TRUE),0)
  
   p <- ggplot(data4, aes(x=Kategorie,fill=Kategorie, y=Anteil,text=paste("N:",Nrund))) + 
    geom_col(aes(frame=Datum,ids = Kategorie),position = "identity",show.legend = FALSE,alpha=.75) + 
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  
    labs(y = "", x= "") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) 
   
   m <- list(l = 40,r = 40,b = 130,t = 40,pad = 4)  

  g <- ggplotly(p,tooltip = c("frame","x","y","text"))  %>% layout(barmode = "dodge") %>%
layout(showlegend = FALSE,
         xaxis = list(ticktext=~Kategoriex),
         legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 0, y = -0.12, text = paste("N ~",Nrund," pro Welle", "Daten: ACPP + WoCo"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='left', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    config(locale = 'de',
           displaylogo = FALSE,
           displayModeBar = TRUE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        )) %>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  g <- g %>% animation_slider(currentvalue = list(prefix = "Befragungsdatum: ", font = list(color="red")))
   } 
   
  if(input$play==TRUE) g %>% animation_slider(currentvalue = list(prefix = "Befragungsdatum: ", font = list(color="red")))
   else g
  
})

  observeEvent(input$var_shares2, {

      inputvariable_shares <- data_labels$variable[data_labels$variable %in% input$var_shares2]

  data4 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% group_by(wavedate) %>%
     mutate(wave = cur_group_id()) %>% ungroup() %>%
    filter(variable %in% inputvariable_shares)

  myval3<-paste("Welle ",names(table(data4$wave))," (",names(table(format(data4$wavedate, "%Y-%m-%d"))),")",sep = "")

  updateSelectInput(session, "waves", choices = myval3)

   })

```

### Anteile der Antwortkategorien in % aller gültigen Antworten {.mobile}

```{r,context="server"}
#output$out1 <- renderPrint(input$var_shares2)
#verbatimTextOutput('out1')

 #Observe changes in variables (will run when variables change)
 

renderPlotly({
  
   inputvariable_shares <- data_labels$variable[data_labels$variable %in% input$var_shares2]
 
   if(input$play==FALSE) 
   {
  data3 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% group_by(wavedate) %>%
     mutate(wave = cur_group_id()) %>% ungroup() %>%
    filter(variable %in% inputvariable_shares & wave %in% str_split(input$waves,pattern=" ",simplify = TRUE)[2])
  data3 <- data3 %>% mutate(Personen = round(prop*N_total,0)) %>% 
                     rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total) %>% 
    mutate(Kategoriex = if_else(row_number() %% 2 == 0, paste0("\n",Kategorie), as.character(Kategorie)))
  
  Nrund<-round(mean(data3$N,na.rm=TRUE),0)
  
  p <- ggplot(data3, aes(fill=Kategorie,x=Kategorie, y=Anteil,text=paste("N:",Nrund))) + 
    geom_bar(show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + 
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  
    labs(y = "", x= "",fill="") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2))+
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 
  
  m <- list(l = 40,r = 40,b = 80,t = 20,pad = 4)
  
  g <- ggplotly(p,tooltip = c("frame","x","y","text"))  %>% layout(barmode = "dodge") %>%
layout(showlegend = FALSE,
         xaxis = list(ticktext=~Kategoriex),
         legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 1.05, y = -0.17, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1.05, y = -0.12, text = paste("N =",Nrund,""), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))%>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
   }
 if(input$play==TRUE)
  {
  data4 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% 
    filter(variable %in% inputvariable_shares) %>% filter(!is.na(measurement))
  data4 <- data4 %>% mutate(Personen = round(prop*N_total,0)) %>% 
                     rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total) %>% 
    mutate(Kategoriex = if_else(row_number() %% 2 == 0, paste0("\n",Kategorie), as.character(Kategorie)),
           Kategorie2 = as.factor(Kategorie),
           Kategorie3 = as.numeric(Kategorie),
           dummy = "a")
  
  Nrund<-round(mean(data4$N,na.rm=TRUE),0)
  
   p <- ggplot(data4, aes(x=Kategorie,fill=Kategorie, y=Anteil,text=paste("N:",Nrund))) + #
    geom_col(aes(frame=Datum,ids = Kategorie),position = "identity",show.legend = FALSE,alpha=.75) + 
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  
    labs(y = "", x= "") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) 
   
   m <- list(l = 40,r = 40,b = 130,t = 40,pad = 4)  

  g <- ggplotly(p,tooltip = c("frame","x","y","text"))  %>% layout(barmode = "dodge") %>%
layout(showlegend = FALSE,
         xaxis = list(ticktext=~Kategoriex),
         legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 0, y = -0.18, text = paste("N ~",Nrund," pro Welle", "Daten: ACPP + WoCo"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='left', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070"))) %>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        )) %>%
    layout(xaxis = list(fixedrange = TRUE), yaxis = list(fixedrange = TRUE))
  g <- g %>% animation_slider(currentvalue = list(prefix = "Befragungsdatum: ", font = list(color="red")))
   } 
   
  if(input$play==TRUE) g %>% animation_slider(currentvalue = list(prefix = "Befragungsdatum: ", font = list(color="red")))
   else g
  
})

  observeEvent(input$var_shares2, {

      inputvariable_shares <- data_labels$variable[data_labels$variable %in% input$var_shares2]

  data4 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% group_by(wavedate) %>%
     mutate(wave = cur_group_id()) %>% ungroup() %>%
    filter(variable %in% inputvariable_shares)

  myval3<-paste("Welle ",names(table(data4$wave))," (",names(table(format(data4$wavedate, "%Y-%m-%d"))),")",sep = "")

  updateSelectInput(session, "waves", choices = myval3)

   })

```
