---
title: "Work & Corona Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    orientation: columns
    favicon: www/favicon-32x32.png
    social: ["menu"]
    navbar:
      - {title: "Source Code", icon: "fa-github", href: "https://github.com/fabiankal/woco", target: "_blank",align: "right"}
---

```{js}
//$('.navbar-inverse').removeClass('navbar-inverse').addClass('navbar-default');
//source_code: "https://github.com/fabiankal/woco"
//fa-area-chart
```

```{css, echo=FALSE}
.js-plotly-plot .plotly .modebar {
    left: 60%;
    transform: translateX(-50%);
}
#section-anmerkungen
  .chart-shim {
    overflow-y: scroll;
    }
/*#section-anmerkungen2
  .chart-shim {
    overflow-y: scroll;
    }*/
```

```{r setup, include=FALSE}
#navbar-bg: "#00102E"
#theme:
#      version: 4
#      bootswatch: flatly
#
#runtime: shiny_prerendered
library(plotly)
library(tidyr)
library(dplyr)
library(rlang)
library(stringr)
library(forcats)
library(base64enc)
#library(bslib)
library(flexdashboard)
library(readr)
library(shiny)

#get a reactive (text) variable
 myval3 <- reactiveValues()
```

```{r data, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
data <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/export_shiny_data.csv",show_col_types = FALSE)

data_shares <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/export_shiny_data_shares.csv",show_col_types = FALSE)

data_labels <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/data_labels_cq.csv",show_col_types = FALSE)
data_labels$scalenumber=data_labels$scalenumber+1
data_varlab <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/varlabels.csv",show_col_types = FALSE)


#epidf = read.delim("Y:/Wirtschaftssoziologie/Corona/Corona_Panel_Analyse/data/raw/CovidFaelle_Timeline.csv", sep=";", header=TRUE)
epidf       <-readr::read_csv("https://raw.githubusercontent.com/fabiankal/woco/master/output/tables/CovidFaelle_Timeline.csv",show_col_types = FALSE)

data_varlab$labels<-gsub(pattern = 'ae', replacement = "ä",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Ae', replacement = "Ä",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'ue', replacement = "ü",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Ue', replacement = "ü",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Daür', replacement = "Dauer",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Aktüll', replacement = "Aktuell",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'oe', replacement = "ö",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Oe', replacement = "Ö",data_varlab$labels)
data_varlab$labels<-gsub(pattern = 'Depressivität', replacement = "Emotionen",data_varlab$labels)

data_labels$q_cate<-gsub(pattern = 'ae', replacement = "ä",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Ae', replacement = "Ä",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'ue', replacement = "ü",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Ue', replacement = "ü",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Daür', replacement = "Dauer",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Aktüll', replacement = "Aktuell",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'oe', replacement = "ö",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Oe', replacement = "Ö",data_labels$q_cate)
data_labels$q_cate<-gsub(pattern = 'Depressivität', replacement = "Emotionen",data_labels$q_cate)

data_labels$labels<-gsub(pattern = 'ae', replacement = "ä",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Ae', replacement = "Ä",data_labels$labels)
data_labels$labels<-gsub(pattern = 'ue', replacement = "ü",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Ue', replacement = "ü",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Daür', replacement = "Dauer",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Aktüll', replacement = "Aktuell",data_labels$labels)
data_labels$labels<-gsub(pattern = 'oe', replacement = "ö",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Oe', replacement = "Ö",data_labels$labels)
data_labels$labels<-gsub(pattern = 'Depressivität', replacement = "Emotionen",data_labels$labels)
data_labels$labels<-gsub(pattern = 'CafÃ©s', replacement = "Cafés",data_labels$labels)


data_labels <- data_labels %>% filter(!is.na(labels))


#Seperate category labels from variable labels and put them in a list

# data_varlab<-data_varlab %>% separate(labels,c("catlabel","varlabel"), ":",remove = FALSE)
# data_varlab<-data_varlab %>% mutate(varlabel=ifelse(is.na(varlabel),catlabel,varlabel))#,
#                                     #catlabel=ifelse(varlabel==catlabel,NA,catlabel))


# xy.list <- split(data_varlab$catlabel,data_varlab$catlabel)
# 
# for (val in unique(data_varlab$catlabel)) {
# xy.list[[val]] <- data_varlab %>% filter(catlabel==val) %>% pull(labels, varlabel)
# }

#Transform variables to list to add categorization
xy.list <- split(data_labels$q_cate,data_labels$q_cate) 
 
 for (val in unique(data_labels$q_cate)) {
 xy.list[[val]] <- data_labels %>% filter(q_cate==val) %>% pull(variable,labels) 
 }

#my_autocomplete_list <- data_varlab$labels[data_varlab$variable %in% unique(data$variable)]
my_autocomplete_list <- xy.list

hlinedata = data.frame(x = c("16.03.2020",
                             "14.04.2020",
                             "15.05.2020",
                             "15.06.2020",
                             "24.07.2020",
                             "21.09.2020",
                             "03.11.2020",
                             "17.11.2020",
                             "07.12.2020",
                             "26.12.2020",
                             "25.01.2021",
                             "08.02.2021",
                             "01.04.2021",
                             "03.05.2021",
                             "19.05.2021",
                             "01.07.2021"),
                     label_en=c("Lockdown",
                             "Easing of\nmeasurments",
                             "Reopening\nrestaurants",
                             "Easing of mask rules",
                             "Mask rules\nnew",
                             "Closing hour",
                             "Nightly\ncurfew",
                             "Lockdown\n",
                             "Reop.\ncommerce",
                             "Lock-\ndown",
                             "FFP2-\nmasks",
                             "Reopening",
                             "Lockdown\neast",
                             "Reopening\neast",
                             "Reopening",
                             "Easing of mask rules"),
                      label_de=c("Lockdown",
                             "Erste\nÖffnungen",
                             "Gastro-\nöffnung",
                             "Lockerung\nMasken",
                             "Maskenpflicht\nneu",
                             "Sperrstunde",
                             "Ausgangs-\nbeschr.",
                             "Lockdown",
                             "Öffnung\nHandel",
                             "Lockdown",
                             "FFP2-\nMasken",
                             "Öffnung",
                             "Lockdown\nOst",
                             "Öffnung\nOst",
                             "Öffnung",
                             "Lockerung\nMasken"),
                       y = c(1.1,1.1,1.1,1.1,1.1,
                             1.1,1.1,1.1,1.1,1.1,
                             1.1,1.1,1.1,1.1,1.1,
                             1.1))

hlinedata$x<-as.Date(hlinedata$x,"%d.%m.%Y")

epidf_rc = epidf %>% filter(BundeslandID==10) %>% rename(daily_inf = names(epidf)[5],
                                                         daily_inf_7T = names(epidf)[7])

epidf_rc$time = as.Date(str_split(string = epidf_rc$Time, 
                        pattern = "[[:space:]]", 
                        simplify = TRUE)[, 1],
                        "%d.%m.%Y")

data$subgroup<-as.factor(data$subgroup)
data$subgroup<-fct_relevel(data$subgroup,"<30","30-59",">60","1-3.Decile","4-7.Decile","8-10.Decile","primary","Lehre","secondary","tertiary","<10.000","10.000–1 Million",">1 Million","female","male","Arbeitend","in Home-office","in Kurzarbeit","Arbeitslos","Nicht-Arbeitend","none")
levels(data$subgroup)<- c("<30","30-59",">60","1.-3. Dezil","4.-7. Dezil","8.-10. Dezil",
                          "primär","Lehre","sekundär","tertiär","<10.000","10.000–1 Million",
                          ">1 Million","weiblich","männlich","Arbeitend","in Home-office","in Kurzarbeit",
                          "Arbeitslos","Nicht-Arbeitend","keine")

data_shares$measurement<-gsub(pattern = 'ae', replacement = "ä",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'ue', replacement = "ü",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'Ue', replacement = "Ü",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'oe', replacement = "ö",data_shares$measurement)
data_shares$measurement<-gsub(pattern = 'Vertraün', replacement = "Vertrauen",data_shares$measurement)

data_shares$measurement<-as.factor(data_shares$measurement)
data_shares$measurement<-fct_relevel(data_shares$measurement,"10 = äusserst zufrieden",after = Inf)
data_shares$measurement<-fct_relevel(data_shares$measurement,"10 = Sehr viel Vertrauen",after = Inf)

```

Verteilung der Antworten {data-icon="fa-area-chart"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------

<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable aus, die Sie anzeigen möchten.


```{r}

selectizeInput(
    inputId = 'var_shares',
    label = 'Variable:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[11]][3],
    multiple = TRUE, # allow for multiple inputs
    options = list(create = FALSE,maxItems = 1)
  )

#Choose Page
page <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$var_shares]," ",simplify = TRUE)[1])

#Dynamic link creation
output$link <- renderUI({
       url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page()),target="_blank")
       tagList("Für Frageformulierung siehe ",url)
    })

#Dynamic link display
uiOutput("link")


#,onDropdownOpen = I("function () {this.clear();}")
#,onDropdownOpen = I("function() {value = this.getValue();this.clear(false)},onBlur: function() {if(this.getValue() == '') { this.setValue(value);}}")

checkboxInput(inputId = 'colordirect', label = "Farbschema umkehren", value = FALSE)

#  radioButtons("inpercent", "Y-Achse:",
#               c("In Prozent" = "percent",
#                 "In Personen" = "persons"
#                 ),
#               selected = "percent",
#               )
  
version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px;right:10px;text-align: right'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/">CC BY 3.0 AT</a>
        </div>'
        ))
```

Column
-----------------------------------------------------------------------

### Anteile der Antwortkategorien in % aller gültigen Antworten nach Befragungswelle {data-height=1000}

```{r,context="server"}

#output$out1 <- renderPrint(as.numeric(input$colordirect))
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariable_shares <- data_varlab$variable[data_varlab$variable %in% input$var_shares]
  
  data3 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>%
    filter(variable %in% inputvariable_shares) 
  data3 <- data3 %>% mutate(Personen = round(prop*N_total,0)) %>% rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total)
  
  Nrund<-round(mean(data3$N,na.rm=TRUE),0)
  
  #if(input$inpercent=="percent")
  #{
  p <- ggplot(data3, aes(fill=Kategorie,x=Datum, y=Anteil)) + 
    geom_area(position="stack", show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + #geom_bar width=0.7
    geom_point(aes(text=paste("N (Welle): ",N)),position=position_stack(),colour="white") +
    #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect)*2)-1)) +  #alternative:Blues
    labs(y = "", x= "",fill="") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_date(date_breaks = "2 month",date_labels = "%b %y",guide = guide_axis(n.dodge = 2))
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 
  #}
  
  # if(input$inpercent=="persons")
  # {
  #  p <- ggplot(data3, aes(fill=Kategorie,x=Datum, y=Personen)) + 
  #   geom_area(position="stack", show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + #geom_bar width=0.7
  #   geom_point(aes(text=paste("N (Welle): ",N)),position=position_stack(),colour="white") +
  #   #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
  #   scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect)*2)-1)) +  #alternative:Blues
  #   labs(y = "", x= "",fill="") +
  #   theme_minimal() +
  #   #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  #   scale_x_date(date_breaks = "2 month",date_labels = "%b %y",guide = guide_axis(n.dodge = 2))
  #   theme(legend.position="bottom") + 
  #   guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE))  
  # }
  
m <- list(l = 0,r = 0,b = 80,t = 40,pad = 4)  

  g <- ggplotly(p,tooltip = c("x","y","fill","text")) %>%
layout(legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 1, y = -0.17, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.12, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))
  #g$x$data[[1]]$hoverinfo <- "none"
  #g$x$data[[2]]$hoverinfo <- "none"
  #g$x$data[[3]]$hoverinfo <- "none"
  #g$x$data[[4]]$hoverinfo <- "none"
  #g$x$data[[5]]$hoverinfo <- "none"
  g
})

```

Mittelwerte {data-icon="fa-line-chart"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------

<i class="fa fa-info-circle"></i> Wählen Sie hier die Variablen aus, die Sie anzeigen möchten.

```{r}
selectizeInput(
    inputId = 'variables',
    label = 'Variablen:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[11]][3:4],
    multiple = TRUE, # allow for multiple inputs
    options = list(create = FALSE), # if TRUE, allows newly created inputs
  )
#selectInput("groupby", label = "Gruppierung (der ersten Variable)",
#            choices = c("Keine","Gender", "Age", "Education", "Region","Income"), selected = "Keine")

#Choose Page
page2 <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$variables]," ",simplify = TRUE)[1])

#Dynamic link creation
output$link2 <- renderUI({
       url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page2()),target="_blank")
       tagList("Für Frageformulierung siehe ",url)
    })

#Dynamic link display
uiOutput("link2")

checkboxInput(inputId = 'confidence', label = "95% Konfidenzintervalle", value = FALSE)
checkboxInput(inputId = 'incidence', label = "7-Tages Inzidenz", value = FALSE)
checkboxInput(inputId = 'relevantdates', label = "Relevante Ergeignisse", value = FALSE)
checkboxInput(inputId = 'axis0', label = "Minimalwert der Y-Achse bei 0 fixieren", value = TRUE)

version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px;right:10px;text-align: right'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/">CC BY 3.0 AT</a>
        </div>'
        ))
# sliderInput("bw_adjust", label = "Bandwidth adjustment:",
#             min = 0.2, max = 2, value = 1, step = 0.2)

```

Column
-----------------------------------------------------------------------

### Mittelwerte nach Befragungswelle {data-height=800}

```{r,context="server"}

#output$out1 <- renderPrint(input$relevantdates)
#verbatimTextOutput('out1')

renderPlotly({
  
  inputvariables <- data_varlab$variable[data_varlab$variable %in% input$variables]
  
  data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales,N_total) %>%
    distinct(wavedate,variable, .keep_all = TRUE) %>%
    filter(variable %in% inputvariables & groupby=="all") %>% left_join(data_varlab,by=c("variable"))%>%
    mutate(y_err=ymax-mean_measurement)
  
  Nrund<-round(mean(data2$N_total,na.rm=TRUE),0)
  m <- list(l = 0,r = 0,b = 80,t = 40,pad = 4)  

  if(input$confidence)
  {
  p <- data2[order(data2$labels),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~labels,
          error_y = ~list(array = y_err))
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis0,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.94,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.13, text = paste("Daten: ACPP + WoCo.","N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    # layout(annotations = 
    #         list(x = 1, y = -0.16, text = paste("N ~",Nrund,"pro Welle"), 
    #         showarrow = F, xref='paper', yref='paper', 
    #         xanchor='right', yanchor='auto', xshift=0, yshift=0,
    #         font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))
  }
  else
  {
  p <- data2[order(data2$labels),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~labels)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis0,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.93,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.13, text = paste("Daten: ACPP + WoCo.","N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    #layout(annotations = 
    #        list(x = 1, y = -0.12, text = paste("N ~",Nrund,"pro Welle"), 
    #        showarrow = F, xref='paper', yref='paper', 
    #        xanchor='right', yanchor='auto', xshift=0, yshift=0,
    #       font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))
  }
 
  if(input$relevantdates)
  {
    vline_list <- list()
    vanno_list <- list()
    for(i in 1:length(hlinedata$x))
      {
        vline_list[[i]] <-list(type      = "line",
                               line      = list(color="black",dash="dash"),
                               opacity   = 0.3,
                               x0        = hlinedata$x[i],
                               x1        = hlinedata$x[i],
                               xref      = "x",
                               y0        = ifelse(input$axis0,0,min(data2$mean_measurement))*0.96,
                               y1        = max(data2$mean_measurement)*1+(((i+1)%%2)*-0.11),
                               yref      = "y")
  
        vanno_list[[i]] <- list(x = hlinedata$x[i],
                                y = max(data2$mean_measurement)*1.02+(((i+1)%%2)*-0.11),
                                text = hlinedata$label_de[i],
                                xref = "x",
                                yref = "y",
                                showarrow = FALSE,
                                arrowhead = 7,
                                ax = 0,
                                ay = 10,
                                font=list(size=9))
    }
    p <- p %>%  layout(shapes  = vline_list,annotations = vanno_list)
  }
  if(input$incidence)
  {
    p <- p  %>% add_trace(x = ~epidf_rc$time, y = ~round((epidf_rc$daily_inf_7T*0.01123461),1), type = 'scatter', mode = 'none', name = '7-Tage Inzidenz',yaxis = "y2", fill = 'tozeroy', inherit = FALSE) %>% layout(yaxis2 = list(overlaying = "y", side = "right",showgrid = F),margin = list(r=30))
  
  }
  
  p
  
})

```

### anmerkungen {.no-title data-height=200}
```{r,context="server"}
#output$out1 <- renderPrint(input$variables)
#verbatimTextOutput('out1')

#get a reactive (text) variable
myval <- reactiveValues()

 #Observe changes in variables (will run when variables change)
  observeEvent(input$variables, {
    
    inputvariables <- data_varlab$variable[data_varlab$variable %in% input$variables]
    
    data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales) %>%
    distinct(wavedate,variable, .keep_all = TRUE) %>%
    filter(variable %in% inputvariables & groupby=="all") #%>%
    #pivot_wider(id_cols = c(wavedate,variable),names_from=variable, values_from=c(mean_measurement,ymax_mean,ymin_mean), names_glue = "{variable}_{.value}")
  
  variables=0
  labels_st=0
  labels_en=0
  labels_ms=0
  labeln_st=0
  labeln_en=0
  text=0
  k=0
  
data_labels$wn[is.na(data_labels$wn)]<-"nown"
data_labels$ka[is.na(data_labels$ka)]<-"noka"
data_labels$nown=NA
data_labels$noka=NA



  for(i in unique(data2$scales))
      {
      k=k+1
       variables[k]=paste(data_varlab$labels[data_varlab$variable %in% unique(data2$variable[data2$scales==i])],collapse='", "')
       labeln_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(V1) %>% distinct(),sep=", ",collapse=", ")
       labeln_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(max) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(paste('V',data_labels %>% filter(scales==i) %>% select(scalenumber) %>% distinct(),sep="")) %>%
                            distinct(),sep=", ",collapse=", ")
       labels_ms[k]=gsub('NA", "',"",paste(data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(wn) %>% distinct())) %>% 
                            distinct(),
                          data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(ka) %>% distinct())) %>% 
                            distinct(),
                          sep='", "'))
       if(data_labels %>% filter(scales==i) %>% select(rev) %>% distinct()=="0") 
         {
         text[k]=paste('&bull; Die Skala der Variable(n)', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_st[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_en[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
       else
         {
         text[k]=paste('&bull; Die Skala der Variable(n)', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_en[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_st[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
  }
   if(k>1) text[1] = paste('<i class="fa fa-exclamation-triangle"></i> Achtung: Variablen mit unterschiedlichen Skalen ausgewählt.<br/>',text[1])
    
     myval$calc <- text #write text in dynamic variable

  })

output$selected_var <- renderUI({
   HTML(paste(myval$calc, collapse="<br/>"))
  })

htmlOutput("selected_var")

```

Gruppierte Mittelwerte {data-icon="fa-users"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------


<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable aus, die Sie anzeigen möchten.

```{r}
selectizeInput(
    inputId = 'variablesgr',
    label = 'Variable:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[11]][3] ,
    multiple = FALSE, # allow for multiple inputs
    options = list(create = FALSE), # if TRUE, allows newly created inputs
  )
selectInput("groupby", label = "Gruppieren nach:",
            choices = c("Keine","Geschlecht", "Alter", "Bildungsgrad", "Einwohnerzahl","Einkommen","Arbeitsmarktstatus"), selected = "Geschlecht")

#Choose Page
page3 <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$variablesgr]," ",simplify = TRUE)[1])

#Dynamic link creation
output$link3 <- renderUI({
       url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page3()),target="_blank")
       tagList("Für Frageformulierung siehe ",url)
    })

#Dynamic link display
uiOutput("link3")

checkboxInput(inputId = 'confidence2', label = "95% Konfidenzintervalle", value = FALSE)
checkboxInput(inputId = 'incidence2', label = "7-Tages Inzidenz", value = FALSE)
checkboxInput(inputId = 'relevantdates2', label = "Relevante Ergeignisse", value = FALSE)
checkboxInput(inputId = 'axis02', label = "Minimalwert der Y-Achse bei 0 fixieren", value = TRUE)

version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px;right:10px;text-align: right'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/">CC BY 3.0 AT</a>
        </div>'
        ))
```

Column
-----------------------------------------------------------------------

### Mittelwerte nach Befragungswelle und Subgruppe {data-height=800}

```{r,context="server"}
#output$out1 <- renderPrint(input$groupby)
#verbatimTextOutput('out1')

# data3 = data %>% select(wavedate,variable,groupby,subgroup,mean_measurement,ymax,ymin) %>%
#     filter(variable %in% test2) %>%
#     filter(case_when(test=="Gender"~ groupby=="ge",
#                test=="Age"~ groupby=="ag"))

renderPlotly({
  
  inputvariables <- data_varlab$variable[data_varlab$variable %in% input$variablesgr]

  data3 = data %>% select(wavedate,variable,groupby,subgroup,mean_measurement,ymax,ymin,N_total) %>%
    filter(variable %in% inputvariables[1]) %>%
    filter(case_when(input$groupby=="Keine"~ groupby=="all",
                     input$groupby=="Geschlecht"~ groupby=="ge",
                     input$groupby=="Alter"~ groupby=="ag",
                     input$groupby=="Bildungsgrad"~ groupby=="ed",
                     input$groupby=="Einwohnerzahl"~ groupby=="bl",
                     input$groupby=="Einkommen"~ groupby=="hi",
                     input$groupby=="Arbeitsmarktstatus"~ groupby=="es")) %>%
    mutate(y_err=ymax-mean_measurement)
  
  data3$subgroup<-as.factor(data3$subgroup)
  data3$subgroup<-droplevels(data3$subgroup)
  
  Nrund<-round(mean(data3$N_total,na.rm=TRUE),0)
  m <- list(l = 0,r = 0,b = 80,t = 40,pad = 4)
  
  if(input$confidence2)
  {
  p <- data3[order(data3$subgroup),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter',mode = 'lines+markers',linetype=~subgroup, 
          error_y = list(array = ~y_err))#,
          #sort = FALSE)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis02,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.94,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.18, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.13, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))
  }
  else
  {
  p <- data3[order(data3$subgroup),] %>%
  plot_ly(x = ~wavedate, y= ~mean_measurement,type = 'scatter', mode = 'lines+markers',linetype=~subgroup)#,
          #sort = FALSE)
  p <- p %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "",rangemode = ifelse(input$axis02,"tozero","normal")),
         legend = list(orientation = 'h'),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.97,y=0.93,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom" 
          ))) %>% 
    layout(margin=m,annotations = 
            list(x = 1, y = -0.18, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.13, text = paste("N ~",Nrund,"pro Welle"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","pan2d"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))
  }
  if(input$relevantdates2)
  {
    vline_list <- list()
    vanno_list <- list()
    for(i in 1:length(hlinedata$x))
      {
        vline_list[[i]] <-list(type      = "line",
                               line      = list(color="black",dash="dash"),
                               opacity   = 0.3,
                               x0        = hlinedata$x[i],
                               x1        = hlinedata$x[i],
                               xref      = "x",
                               y0        = ifelse(input$axis02,0,min(data3$mean_measurement))*0.96,
                               y1        = max(data3$mean_measurement)*1+(((i+1)%%2)*-0.11),
                               yref      = "y")
  
        vanno_list[[i]] <- list(x = hlinedata$x[i],
                                y = max(data3$mean_measurement)*1.02+(((i+1)%%2)*-0.11),
                                text = hlinedata$label_de[i],
                                xref = "x",
                                yref = "y",
                                showarrow = FALSE,
                                arrowhead = 7,
                                ax = 0,
                                ay = 10,
                                font=list(size=9))
    }
    p <- p %>%  layout(shapes  = vline_list,annotations = vanno_list)
  }
  if(input$incidence2)
  {
    p <- p %>% add_trace(x = ~epidf_rc$time, y = ~round((epidf_rc$daily_inf_7T*0.01123461),1), type = 'scatter', mode = 'none', name = '7-Tage Inzidenz',yaxis = "y2", fill = 'tozeroy', inherit = FALSE) %>% layout(yaxis2 = list(overlaying = "y", side = "right",showgrid = F),margin = list(r=30))
  }

  p
})

```

### anmerkungen2 {.no-title data-height=200}

```{r,context="server"}
 #output$out1 <- renderPrint(input$variables)
 #verbatimTextOutput('out1')
 
 #get a reactive (text) variable
 myval2 <- reactiveValues()
 
  #Observe changes in variables (will run when variables change)
   observeEvent(input$variablesgr, {
     
     inputvariables <- data_varlab$variable[data_varlab$variable %in% input$variablesgr]
     
     data2 = data %>% select(wavedate,variable,groupby,mean_measurement,ymax,ymin,scales) %>%
     distinct(wavedate,variable, .keep_all = TRUE) %>%
     filter(variable %in% inputvariables & groupby=="all") #%>%
     #pivot_wider(id_cols = c(wavedate,variable),names_from=variable, values_from=c(mean_measurement,ymax_mean,ymin_mean), names_glue = "{variable}_{.value}")
#   
   variables=0
   labels_st=0
   labels_en=0
   labels_ms=0
   labeln_st=0
   labeln_en=0
   text=0
   k=0
  
 data_labels$wn[is.na(data_labels$wn)]<-"nown"
 data_labels$ka[is.na(data_labels$ka)]<-"noka"
 data_labels$nown=NA
 data_labels$noka=NA
   

  for(i in unique(data2$scales))
      {
      k=k+1
       variables[k]=paste(data_varlab$labels[data_varlab$variable %in% unique(data2$variable[data2$scales==i])],collapse='", "')
       labeln_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_st[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(V1) %>% distinct(),sep=", ",collapse=", ")
       labeln_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(max) %>% distinct()-
                          data_labels %>% filter(scales==i) %>% 
                            select(min) %>% distinct(),sep=", ",collapse=", ")
       labels_en[k]=paste(data_labels %>% filter(scales==i) %>% 
                            select(paste('V',data_labels %>% filter(scales==i) %>% select(scalenumber) %>% distinct(),sep="")) %>%
                            distinct(),sep=", ",collapse=", ")
       labels_ms[k]=gsub('NA", "',"",paste(data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(wn) %>% distinct())) %>% 
                            distinct(),
                          data_labels %>% filter(scales==i)  %>% 
                            select(paste0(data_labels %>% filter(scales==i) %>% select(ka) %>% distinct())) %>% 
                            distinct(),
                          sep='", "'))
       if(data_labels %>% filter(scales==i) %>% select(rev) %>% distinct()=="0") 
         {
         text[k]=paste('&bull; Die Skala der Variable', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_st[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_en[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
       else
         {
         text[k]=paste('&bull; Die Skala der Variable', paste0('"',variables[k],'"'), 'geht von',paste0('"',labeln_st[k]),'=',paste0(labels_en[k],'"'),'bis',paste0('"',labeln_en[k]),'=',paste0(labels_st[k],'"'),'. Ausweichoption(en):',paste0('"',labels_ms[k],'"'), sep=" ", collapse=" ")
         }
  }
   if(k>1) text[1] = paste('<i class="fa fa-exclamation-triangle"></i> Achtung: Variablen mit unterschiedlichen Skalen ausgewählt.<br/>',text[1])
    
     myval2$calc <- text #write text in dynamic variable

  })
 
 output$selected_var2 <- renderUI({
    HTML(paste(myval2$calc, collapse="<br/>"))
   })
 
 htmlOutput("selected_var2")

```

Querschnitte {data-icon="fa-bar-chart"}
=======================================================================

{.sidebar}
-----------------------------------------------------------------------


<i class="fa fa-info-circle"></i> Wählen Sie hier die Variable aus, die Sie anzeigen möchten.


```{r}

selectInput(
    inputId = 'var_shares2',
    label = 'Variable:',
    choices = my_autocomplete_list,
    selected = my_autocomplete_list[[11]][3],
    multiple = FALSE, # allow for multiple inputs
    #options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

#Choose Page
page4 <- reactive(str_split(data_labels$q_cate[data_labels$variable %in% input$var_shares2]," ",simplify = TRUE)[1])

#Dynamic link creation
output$link4 <- renderUI({
       url <- a("hier", href=paste0("https://woco.univie.ac.at/dashboard/variablen/?",page4()),target="_blank")
       tagList("Für Frageformulierung siehe ",url)
    })

#Dynamic link display
uiOutput("link4")

selectInput(
    inputId = 'waves',
    label = 'Umfrage-Welle: (mittleres Befragungsdatum in Klammern)',
    choices = "1",
    selected = "1",
    multiple = FALSE, # allow for multiple inputs
    #options = list(create = FALSE), # if TRUE, allows newly created inputs
  )

checkboxInput(inputId = 'colordirect2', label = "Farbschema umkehren", value = FALSE)

 # radioButtons("inpercent2", "Y-Achse:",
#               c("In Prozent" = "percent",
#                 "In Personen" = "persons"
#                 )
#               )
checkboxInput(inputId = 'play', label = "Wellen dynamisch abspielen (BETA)", value = FALSE)

version<-"V1.0"
HTML(paste0(
        "<div style='position: absolute; bottom: 5px;right:10px;text-align: right'>",
        "WoCo-Dashboard ",version,"<br>",Sys.Date(),'<br> Lizenz:  <a href="https://creativecommons.org/licenses/by/3.0/at/">CC BY 3.0 AT</a>
        </div>'
        ))
```


Column
-----------------------------------------------------------------------

### Anteile der Antwortkategorien in % aller gültigen Antworten {data-height=1000}

```{r,context="server"}
#output$out1 <- renderPrint(input$var_shares2)
#verbatimTextOutput('out1')

 #Observe changes in variables (will run when variables change)
 

renderPlotly({
  
   inputvariable_shares <- data_varlab$variable[data_varlab$variable %in% input$var_shares2]
 
   if(input$play==FALSE) 
   {
  data3 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% group_by(wavedate) %>%
     mutate(wave = cur_group_id()) %>% ungroup() %>%
    filter(variable %in% inputvariable_shares & wave %in% str_split(input$waves,pattern=" ",simplify = TRUE)[2])
  data3 <- data3 %>% mutate(Personen = round(prop*N_total,0)) %>% 
                     rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total) %>% 
    mutate(Kategoriex = if_else(row_number() %% 2 == 0, paste0("\n",Kategorie), as.character(Kategorie)))
  
  Nrund<-round(mean(data3$N,na.rm=TRUE),0)
  
 # if(input$inpercent2=="percent")
 # {
  p <- ggplot(data3, aes(fill=Kategorie,x=Kategorie, y=Anteil,text=paste("N:",Nrund))) + 
    geom_bar(show.legend = TRUE,stat = "identity",colour="white",alpha=.75) + 
    #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  #alternative:Blues
    labs(y = "", x= "",fill="") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2))+
    theme(legend.position="bottom") + 
    guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE)) 
 # }
  
  # if(input$inpercent2=="persons")
  # {
  #  p <- ggplot(data3, aes(fill=Kategorie,x=Kategorie, y=Personen,text=paste("N:",Nrund))) + 
  #   geom_bar(show.legend = TRUE,stat = "identity",colour="white",alpha=.75) +
  #   #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
  #   scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  #alternative:Blues
  #   labs(y = "", x= "",fill="") +
  #   theme_minimal() +
  #   #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  #   scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  #   theme(legend.position="bottom") + 
  #   guides(fill=guide_legend(ncol=5,nrow=1,byrow=TRUE))  
  # }
  
  m <- list(l = 40,r = 40,b = 80,t = 40,pad = 4)
  
  g <- ggplotly(p,tooltip = c("frame","x","y","text"))  %>% layout(barmode = "dodge") %>%
layout(showlegend = FALSE,
         xaxis = list(ticktext=~Kategoriex),
         legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 1, y = -0.17, text = "Daten: ACPP + WoCo", 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    layout(annotations = 
            list(x = 1, y = -0.12, text = paste("N =",Nrund,""), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='right', yanchor='auto', xshift=0, yshift=0,
            font=list(size=12, color="#707070")))%>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        ))
   }
 if(input$play==TRUE)
  {
  data4 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% 
    filter(variable %in% inputvariable_shares) %>% filter(!is.na(measurement))
  data4 <- data4 %>% mutate(Personen = round(prop*N_total,0)) %>% 
                     rename(Datum = wavedate,
                            Anteil = prop,
                            Kategorie = measurement,
                            N = N_total) %>% 
    mutate(Kategoriex = if_else(row_number() %% 2 == 0, paste0("\n",Kategorie), as.character(Kategorie)),
           Kategorie2 = as.factor(Kategorie),
           Kategorie3 = as.numeric(Kategorie),
           dummy = "a")
  
  Nrund<-round(mean(data4$N,na.rm=TRUE),0)
  
   p <- ggplot(data4, aes(x=Kategorie,fill=Kategorie, y=Anteil,text=paste("N:",Nrund))) + #
    geom_col(aes(frame=Datum,ids = Kategorie),position = "identity",show.legend = FALSE,alpha=.75) + #identity
    #geom_text(aes(label=round(prop*100, digits = 0)), position=position_stack(vjust=0.5), color="black", size=2) +
    scale_fill_brewer(palette = "RdYlBu", direction=((as.numeric(input$colordirect2)*2)-1)) +  #alternative:Blues
    #scale_fill_manual(values = c("blue", "blue", "green","yellow","orange")) +
    labs(y = "", x= "") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) 
   
   m <- list(l = 40,r = 40,b = 130,t = 40,pad = 4)  

  g <- ggplotly(p,tooltip = c("frame","x","y","text"))  %>% layout(barmode = "dodge") %>%
layout(showlegend = FALSE,
         xaxis = list(ticktext=~Kategoriex),
         legend = list(orientation = "h",sort = FALSE,x = -0.1, y = -0.045),
         images = list(list(  
          source =  base64enc::dataURI(file = "logo2.png"), 
          xref = "paper",  
          yref = "paper",
          x=0.95,y=0.955,
          sizex = 0.25,sizey = 0.25,  
          xanchor="right",yanchor="bottom"
          )),
       margin=m)  %>% 
    layout(annotations = 
            list(x = 0, y = -0.12, text = paste("N ~",Nrund," pro Welle", "Daten: ACPP + WoCo"), 
            showarrow = F, xref='paper', yref='paper', 
            xanchor='left', yanchor='auto', xshift=0, yshift=0,
            font=list(size=14, color="#707070"))) %>% 
    config(locale = 'de',
           displaylogo = FALSE,
           modeBarButtonsToRemove = c("select2d", "lasso2d","autoScale2d","zoom2d","zoomIn2d","zoomOut2d","hoverCompareCartesian","pan2d","hoverClosestCartesian"),
           toImageButtonOptions = list(format = "png",width = 800,height = 600,scale = 4
        )) 
  g <- g %>% animation_slider(currentvalue = list(prefix = "Befragungsdatum: ", font = list(color="red")))
   } 
   
  if(input$play==TRUE) g %>% animation_slider(currentvalue = list(prefix = "Befragungsdatum: ", font = list(color="red")))
   else g
  
})

  observeEvent(input$var_shares2, {

      inputvariable_shares <- data_varlab$variable[data_varlab$variable %in% input$var_shares2]

  data4 = data_shares %>% select(wavedate,variable,measurement,prop,N_total) %>% group_by(wavedate) %>%
     mutate(wave = cur_group_id()) %>% ungroup() %>%
    filter(variable %in% inputvariable_shares)

  myval3<-paste("Welle ",names(table(data4$wave))," (",names(table(format(data4$wavedate, "%Y-%m-%d"))),")",sep = "")

  updateSelectInput(session, "waves", choices = myval3)

   })

```
